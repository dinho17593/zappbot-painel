
<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Painel ZappBot</title>
    
    <!-- PWA Meta Tags -->
    <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
    <meta name="theme-color" content="#121214">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="ZappBot">
    
    <link rel="apple-touch-icon" href="icon-192.png">
    <link rel="icon" type="image/png" href="icon-192.png">
    <link rel="shortcut icon" href="icon-192.png" type="image/x-icon">
    <link rel="manifest" href="/manifest.json">

    <script src="/socket.io/socket.io.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-body: #121214;
            --bg-card: #202024;
            --bg-input: #121214;
            --text-main: #e1e1e6;
            --text-muted: #a8a8b3;
            --border: #323238;
            
            --primary: #808085;       
            --primary-hover: #98989d; 
            --purple-dark: #45454a;   
            
            --green: #04d361;
            --red: #f75a68;
            --blue: #3294F8;
            --yellow: #FBA94C;
            --cyan: #61dafb;
            --header-height: 60px;
        }

        * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }
        body { font-family: 'Inter', sans-serif; background-color: var(--bg-body); color: var(--text-main); margin: 0; padding-bottom: 80px; }
        
        /* Estilo da Barra de Atualiza√ß√£o PWA */
        #pwa-update-bar {
            display: none;
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--primary);
            color: white;
            padding: 12px 20px;
            border-radius: 50px;
            z-index: 9999;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            align-items: center;
            gap: 15px;
            font-weight: 600;
            width: 90%;
            max-width: 400px;
            justify-content: space-between;
        }
        #pwa-update-bar.show { display: flex; animation: slideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1); }
        #pwa-update-btn {
            background: white;
            color: var(--primary);
            border: none;
            padding: 6px 12px;
            border-radius: 20px;
            font-weight: 800;
            cursor: pointer;
            font-size: 0.75rem;
        }

        .container { max-width: 1200px; margin: 0 auto; padding: 15px; }
        .hidden { display: none !important; }
        .text-truncate { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        
        .input-group { margin-bottom: 25px; } 
        
        .input-label { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; font-weight: 600; font-size: 0.95rem; color: var(--text-main); }
        .help-text { font-size: 0.85rem; color: var(--text-muted); margin-bottom: 10px; display: block; line-height: 1.5; }
        .example-link { color: var(--cyan); cursor: pointer; font-size: 0.8rem; text-decoration: underline; white-space: nowrap; }

        header { position: sticky; top: 0; z-index: 100; background: rgba(32, 32, 36, 0.95); backdrop-filter: blur(10px); border-bottom: 1px solid var(--border); box-shadow: 0 4px 20px rgba(0,0,0,0.5); }
        .nav-bar { height: var(--header-height); display: flex; align-items: center; justify-content: space-between; padding: 0 15px; position: relative; }
        
        .nav-btn { 
            background: transparent; 
            border: none; 
            color: var(--text-main); 
            font-size: 1.2rem; 
            padding: 10px; 
            cursor: pointer; 
            border-radius: 50%; 
            width: 40px; 
            height: 40px; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            transition: background 0.2s; 
            text-decoration: none; 
        }
        .nav-btn:active { background: rgba(255,255,255,0.1); }
        .nav-btn.logout { color: var(--red); }
        
        .brand-center { position: absolute; left: 50%; top: 50%; transform: translate(-50%, -50%); font-size: 1.2rem; font-weight: 700; color: var(--text-main); display: flex; align-items: center; gap: 8px; white-space: nowrap; }
        .brand-center i { color: var(--primary); }
        .user-strip { background: #18181b; border-bottom: 1px solid var(--border); padding: 8px 15px; text-align: center; font-size: 0.8rem; color: var(--text-muted); display: flex; justify-content: center; align-items: center; gap: 8px; }
        .limit-badge { background: var(--bg-card); border: 1px solid var(--border); padding: 4px 10px; border-radius: 6px; font-size: 0.75rem; color: var(--yellow); cursor: pointer; display: flex; align-items: center; gap: 5px; }

        input, textarea { width: 100%; padding: 14px; background: var(--bg-input); border: 1px solid var(--border); border-radius: 8px; color: var(--text-main); font-size: 1rem; font-family: 'Inter', sans-serif; }
        input:focus, textarea:focus { border-color: var(--primary); }
        button { cursor: pointer; font-family: 'Inter', sans-serif; border: none; }
        
        .btn-primary { 
            background: var(--primary); 
            color: white; 
            padding: 16px; 
            border-radius: 8px; 
            font-weight: 600; 
            width: 100%; 
            font-size: 1rem; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            gap: 8px; 
            box-shadow: 0 4px 15px rgba(128, 128, 133, 0.3); 
            transition: 0.2s; 
        }
        .btn-primary:active { transform: scale(0.98); }
        .btn-primary:disabled { background: #444; color: #888; cursor: not-allowed; box-shadow: none; }

        .btn-google { background: white; color: #333; width: 100%; padding: 12px; border-radius: 8px; font-weight: 600; display: flex; align-items: center; justify-content: center; gap: 10px; text-decoration: none; transition: background 0.2s; border: 1px solid #ddd; }
        .btn-google:hover { background: #f0f0f0; }
        .btn-google svg { width: 20px; height: 20px; }
        .auth-divider { position: relative; margin: 25px 0; text-align: center; }
        .auth-divider span { background: var(--bg-card); padding: 0 10px; color: var(--text-muted); font-size: 0.8rem; position: relative; z-index: 1; }
        .auth-divider::before { content: ''; position: absolute; top: 50%; left: 0; width: 100%; height: 1px; background: var(--border); z-index: 0; }

        .auth-wrapper { display: flex; justify-content: center; align-items: center; min-height: 100vh; padding: 20px; background: radial-gradient(circle at top, #2c2c35 0%, #121214 100%); }
        .auth-card { background: var(--bg-card); padding: 30px; border-radius: 16px; border: 1px solid var(--border); width: 100%; max-width: 400px; box-shadow: 0 20px 40px rgba(0,0,0,0.4); }

        #bots-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 20px; margin-top: 20px; }
        .bot-card { background: var(--bg-card); border: 1px solid var(--border); border-radius: 16px; overflow: hidden; display: flex; flex-direction: column; position: relative; }
        .card-header { padding: 15px; background: rgba(255,255,255,0.03); border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        .status-badge { font-size: 0.7rem; padding: 4px 10px; border-radius: 20px; font-weight: 700; text-transform: uppercase; display: flex; align-items: center; gap: 5px; }
        .st-online { background: rgba(4, 211, 97, 0.1); color: var(--green); border: 1px solid rgba(4, 211, 97, 0.2); }
        .st-offline { background: rgba(168, 168, 179, 0.1); color: var(--text-muted); border: 1px solid rgba(168, 168, 179, 0.2); }
        .st-waiting { color: var(--blue); border: 1px solid var(--blue); }
        .st-expired { color: var(--red); border: 1px solid var(--red); }
        .st-inactive { color: var(--yellow); border: 1px solid var(--yellow); }

        .card-body { padding: 20px; flex-grow: 1; display: flex; flex-direction: column; gap: 15px; }
        .progress-container { position: relative; margin-top: 5px; }
        .progress-info { display: flex; justify-content: space-between; font-size: 0.8rem; margin-bottom: 5px; color: var(--text-muted); }
        .progress-bar-bg { height: 6px; background: #333; border-radius: 3px; overflow: hidden; }
        .progress-bar-fill { height: 100%; background: var(--primary); border-radius: 3px; transition: width 0.5s ease; box-shadow: 0 0 10px var(--primary); }
        
        .date-info { display: flex; justify-content: space-between; font-size: 0.7rem; color: var(--text-muted); padding: 2px 0; }
        .date-info strong { color: var(--text-main); font-weight: 500; }

        .logs-container { background: #0d0d0d; border-radius: 8px; border: 1px solid #333; padding: 10px; font-family: 'Courier New', monospace; font-size: 0.7rem; color: #00ff00; height: 120px; overflow-y: auto; display: flex; flex-direction: column; }
        .log-line { padding: 2px 0; border-bottom: 1px solid rgba(255,255,255,0.05); }

        .qr-area { background:#fff; padding:15px; border-radius:8px; align-self:center; display: flex; flex-direction: column; align-items: center; text-align: center; width: 100%; }
        .qr-instructions { color: #333; margin-bottom: 10px; font-size: 0.8rem; text-align: left; width: 100%; }
        .qr-instructions ol { padding-left: 20px; margin: 5px 0; }
        .qr-instructions li { margin-bottom: 4px; }
        
        .btn-share-qr {
            background: var(--primary);
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 8px;
            margin-top: 12px;
            cursor: pointer;
            font-size: 0.85rem;
            display: flex;
            align-items: center;
            gap: 8px;
            width: 100%;
            justify-content: center;
            font-weight: 600;
            transition: background 0.2s;
        }
        .btn-share-qr:active { transform: scale(0.98); background: var(--primary-hover); }

        .btn-use-code {
            background: transparent;
            color: var(--primary);
            border: 1px solid var(--primary);
            padding: 8px 15px;
            border-radius: 8px;
            margin-top: 8px;
            cursor: pointer;
            font-size: 0.8rem;
            width: 100%;
            font-weight: 600;
        }

        .pairing-code-display {
            font-size: 1.8rem;
            font-weight: 800;
            color: #333;
            letter-spacing: 2px;
            margin: 15px 0;
            background: #f0f0f0;
            padding: 10px;
            border-radius: 8px;
            border: 2px dashed #ccc;
        }

        .action-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-top: 10px; }
        .icon-btn { background: rgba(255,255,255,0.03); border-radius: 12px; padding: 12px 5px; color: var(--text-muted); display: flex; flex-direction: column; align-items: center; gap: 5px; transition: 0.2s; border: 1px solid transparent; text-decoration: none; }
        .icon-btn:active { background: rgba(255,255,255,0.1); transform: scale(0.95); }
        .icon-btn i { font-size: 1.3rem; margin-bottom: 2px; }
        .icon-btn span { font-size: 0.65rem; font-weight: 500; }
        
        .btn-act-start { color: var(--green); }
        .btn-act-stop { color: var(--red); }
        .btn-act-pay { color: var(--cyan); border-color: rgba(97, 218, 251, 0.2); background: rgba(97, 218, 251, 0.05); }

        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 2000; align-items: center; justify-content: center; backdrop-filter: blur(5px); }
        .modal-content { background: var(--bg-card); padding: 25px; border-radius: 16px; width: 90%; max-width: 450px; border: 1px solid var(--border); animation: slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1); max-height: 90vh; overflow-y: auto; }
        @keyframes slideUp { from { transform: translateY(50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .form-section { background: var(--bg-card); border: 1px solid var(--border); border-radius: 12px; padding: 20px; margin-bottom: 20px; }
        
        .plan-option { background: rgba(255,255,255,0.03); border: 1px solid var(--border); padding: 15px; border-radius: 8px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; cursor: pointer; transition: 0.2s; }
        .plan-option:hover { background: rgba(255,255,255,0.08); border-color: var(--cyan); }
        .plan-title { font-weight: 600; font-size: 1rem; color: var(--text-main); }
        .plan-desc { font-size: 0.75rem; color: #888; margin-top: 4px; }
        .plan-price { font-weight: 700; color: var(--green); font-size: 1.1rem; }
        .plan-badge-resell { background: var(--purple-dark); color: #fff; font-size: 0.65rem; padding: 2px 6px; border-radius: 4px; margin-left: 5px; }

        #feedback-area { 
            position: fixed; 
            top: 20px; 
            left: 50%; 
            transform: translateX(-50%); 
            z-index: 10000; 
            padding: 12px 25px; 
            border-radius: 30px; 
            font-size: 0.95rem; 
            font-weight: 600; 
            box-shadow: 0 5px 20px rgba(0,0,0,0.5); 
            display: none; 
            width: 90%; 
            max-width: 320px; 
            text-align: center; 
        }
        .feedback-success { background: var(--green); color: #000; }
        .feedback-error { background: var(--red); color: #fff; }

        .section-divider-title { font-size: 0.8rem; color: var(--cyan); margin: 20px 0 10px 0; border-bottom: 1px solid rgba(97, 218, 251, 0.2); padding-bottom: 5px; }
        .admin-tools { margin-top: 15px; padding-top: 15px; border-top: 1px dashed #333; display: flex; align-items: center; justify-content: space-between; gap: 10px; }
        .admin-tools span { font-size: 0.75rem; color: #666; font-weight: bold; }
        .counter-wrapper { display: flex; align-items: center; background: var(--bg-input); border: 1px solid var(--border); border-radius: 6px; overflow: hidden; }
        .counter-btn { background: rgba(255,255,255,0.05); border: none; color: var(--text-main); padding: 8px 12px; cursor: pointer; transition: 0.2s; }
        .counter-btn:hover { background: rgba(255,255,255,0.1); }
        .days-input { width: 50px !important; text-align: center; border: none !important; margin: 0 !important; padding: 5px !important; background: transparent !important; font-weight: bold; -moz-appearance: textfield; }
        .days-input::-webkit-outer-spin-button, .days-input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        
        .btn-save-days { 
            background: var(--primary); 
            color: white; 
            border: none; 
            border-radius: 6px; 
            width: 36px; 
            height: 36px; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            cursor: pointer; 
            box-shadow: 0 2px 10px rgba(128, 128, 133, 0.2); 
        }
   
        .list-container {
            max-height: 200px; overflow-y: auto; background: var(--bg-input);
            border-radius: 8px; border: 1px solid var(--border); padding: 10px; margin-bottom: 15px;
        }
        .ignored-item {
            display: flex; justify-content: space-between; align-items: center;
            background: rgba(255,255,255,0.05); padding: 8px 12px; border-radius: 6px;
            font-size: 0.9rem; margin-bottom: 5px; font-weight: 600;
        }
        .ignored-item .fas.fa-times { color: var(--red); cursor: pointer; padding: 5px; }

        .payment-success-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            width: 100%;
            text-align: center;
        }

        .qr-wrapper {
            background: #fff;
            padding: 15px;
            border-radius: 12px;
            margin: 15px auto;
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            width: fit-content;
        }

        .amount-display {
            font-size: 2.2rem;
            color: #fff;
            font-weight: 800;
            margin: 10px 0 5px 0;
            letter-spacing: -0.5px;
        }

        .copy-row {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            width: 100%;
            justify-content: center;
        }

        .input-copy {
            background: var(--bg-input);
            border: 1px solid var(--border);
            color: var(--text-muted);
            padding: 10px;
            border-radius: 8px;
            font-size: 0.8rem;
            text-align: center;
            width: 100%;
            margin: 0 !important;
        }

        .btn-copy {
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 0 20px;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .btn-share-pix {
            background: #fff;
            color: #333;
            border: 1px solid #ccc;
            width: 100%;
            padding: 10px;
            border-radius: 8px;
            margin-top: 10px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: background 0.2s;
        }
        .btn-share-pix:active { background: #eee; transform: scale(0.98); }

        .btn-support {
            position: fixed;
            bottom: 25px;
            right: 25px;
            width: 60px;
            height: 60px;
            background-color: #25D366; 
            color: #fff;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            box-shadow: 0 4px 15px rgba(0,0,0,0.4);
            z-index: 10001;
            transition: all 0.3s ease;
            text-decoration: none; 
        }
        .btn-support:hover {
            transform: scale(1.1);
            background-color: #128C7E;
        }
        .btn-support:active {
            transform: scale(0.9);
        }
    </style>
</head>
<body>

    <!-- BARRA DE ATUALIZA√á√ÉO PWA -->
    <div id="pwa-update-bar">
        <span>Nova vers√£o dispon√≠vel!</span>
        <button id="pwa-update-btn">ATUALIZAR AGORA</button>
    </div>

    <!-- FEEDBACK (TOAST) -->
    <div id="feedback-area"></div>

    <!-- AUTHENTICATION -->
    <div id="auth-section" class="auth-wrapper">
        <div class="auth-card">
            <div style="text-align: center; margin-bottom: 30px;">
                <h1 style="color: var(--primary); margin: 0; font-size: 2rem;"><i class="fas fa-robot"></i></h1>
                <h2 style="margin: 5px 0 0 0; font-size: 1.5rem;">ZappBot</h2>
                <p style="color: var(--text-muted); font-size: 0.9rem;">Automa√ß√£o Simplificada</p>
            </div>
            <div id="login-form-container">
                <form id="login-form">
                    <div class="input-group" style="margin-bottom:15px;"><label class="input-label">Seu Email ou Usu√°rio</label><input type="text" id="login-username" required></div>
                    <div class="input-group" style="margin-bottom:20px;"><label class="input-label">Sua Senha</label><input type="password" id="login-password" required></div>
                    <button type="submit" id="btn-login-submit" class="btn-primary">Entrar no Painel</button>
                </form>
                <div class="auth-divider"><span>ou continue com</span></div>
                <a href="/auth/google" class="btn-google"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48"><path fill="#FFC107" d="M43.611,20.083H42V20H24v8h11.303c-1.649,4.657-6.08,8-11.303,8c-6.627,0-12-5.373-12-12c0-6.627,5.373-12,12-12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C12.955,4,4,12.955,4,24c0,11.045,8.955,20,20,20c11.045,0,20-8.955,20-20C44,22.659,43.862,21.35,43.611,20.083z"/><path fill="#FF3D00" d="M6.306,14.691l6.571,4.819C14.655,15.108,18.961,12,24,12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C16.318,4,9.656,8.337,6.306,14.691z"/><path fill="#4CAF50" d="M24,44c5.166,0,9.86-1.977,13.409-5.192l-6.19-5.238C29.211,35.091,26.715,36,24,36c-5.202,0-9.619-3.317-11.283-7.946l-6.522,5.025C9.505,39.556,16.227,44,24,44z"/><path fill="#1976D2" d="M43.611,20.083H42V20H24v8h11.303c-0.792,2.237-2.231,4.166-4.087,5.571c0.001-0.001,0.002-0.001,0.003-0.002l6.19,5.238C36.971,39.205,44,34,44,24C44,22.659,43.862,21.35,43.611,20.083z"/></svg> Google</a>
                <p class="text-center" style="margin-top: 20px; font-size: 0.9rem;"><a href="#" style="color: var(--text-muted); text-decoration: none;" onclick="toggleAuthForms()">N√£o tem conta? Crie aqui</a></p>
            </div>
            <div id="register-form-container" class="hidden">
                <form id="register-form">
                    <div class="input-group" style="margin-bottom:15px;"><label class="input-label">Crie um Usu√°rio</label><input type="text" id="register-username" required></div>
                    <div class="input-group" style="margin-bottom:20px;"><label class="input-label">Crie uma Senha</label><input type="password" id="register-password" required></div>
                    <button type="submit" id="btn-register-submit" class="btn-primary">Criar Conta Gr√°tis</button>
                </form>
                <div class="auth-divider"><span>ou cadastre com</span></div>
                <a href="/auth/google" class="btn-google"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48"><path fill="#FFC107" d="M43.611,20.083H42V20H24v8h11.303c-1.649,4.657-6.08,8-11.303,8c-6.627,0-12-5.373-12-12c0-6.627,5.373-12,12-12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C12.955,4,4,12.955,4,24c0,11.045,8.955,20,20,20c11.045,0,20-8.955,20-20C44,22.659,43.862,21.35,43.611,20.083z"/><path fill="#FF3D00" d="M6.306,14.691l6.571,4.819C14.655,15.108,18.961,12,24,12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C16.318,4,9.656,8.337,6.306,14.691z"/><path fill="#4CAF50" d="M24,44c5.166,0,9.86-1.977,13.409-5.192l-6.19-5.238C29.211,35.091,26.715,36,24,36c-5.202,0-9.619-3.317-11.283-7.946l-6.522,5.025C9.505,39.556,16.227,44,24,44z"/><path fill="#1976D2" d="M43.611,20.083H42V20H24v8h11.303c-0.792,2.237-2.231,4.166-4.087,5.571c0.001-0.001,0.002-0.001,0.003-0.002l6.19,5.238C36.971,39.205,44,34,44,24C44,22.659,43.862,21.35,43.611,20.083z"/></svg> Google</a>
                <p class="text-center" style="margin-top: 20px; font-size: 0.9rem;"><a href="#" style="color: var(--text-muted); text-decoration: none;" onclick="toggleAuthForms()">Voltar para Login</a></p>
            </div>
        </div>
    </div>

    <!-- MAIN DASHBOARD -->
    <div id="dashboard-container" class="hidden">
        <header>
            <div class="nav-bar">
                <button id="nav-back-btn" class="nav-btn hidden" onclick="goBackToAdminHome()"><i class="fas fa-chevron-left"></i></button>
                <div id="nav-placeholder" class="nav-btn" style="visibility: hidden; width: 40px;"></div>
                <div class="brand-center"><i class="fas fa-robot"></i> ZappBot</div>
                <a href="#" class="nav-btn logout" title="Sair" onclick="confirmLogout()"><i class="fas fa-sign-out-alt"></i></a>
            </div>
            <div class="user-strip">
                <i class="fas fa-user-circle"></i> Ol√°, <strong id="user-display-name" class="text-truncate">...</strong>
                <div id="user-limit-badge" class="limit-badge" onclick="openResellModal()" title="Clique para aumentar seu limite">Limite: <span id="current-limit-display">1</span> <i class="fas fa-plus-circle" style="font-size:0.6rem;"></i></div>
            </div>
        </header>
        <div class="container">
            <!-- PAINEL DE ADMINISTRA√á√ÉO -->
            <div id="admin-panel" class="hidden">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-top:10px;">
                    <h3 style="margin:0;">Painel de Controle (Admin)</h3>
                </div>
                
                <div class="form-section" style="border-color: var(--primary); background: rgba(128, 128, 133, 0.1); margin-top: 20px;">
                     <button onclick="goToMyBotsAdmin()" class="btn-primary" style="background: var(--primary); color: white;">
                        <i class="fas fa-robot"></i> ü§ñ Gerenciar Meus Bots (Admin)
                    </button>
                    <p style="text-align: center; color: var(--text-muted); font-size: 0.8rem; margin-top: 10px;">Acesse sua √°rea pessoal de cria√ß√£o de rob√¥s ilimitados.</p>
                </div>

                <div class="form-section" style="border-color: var(--cyan);">
                    <h4 style="color: var(--cyan); margin-top: 0; margin-bottom: 15px;"><i class="fas fa-cog"></i> Pre√ßos e Configura√ß√µes</h4>
                    <form id="admin-settings-form">
                        <div class="input-group"><label class="input-label">Token MercadoPago (Produ√ß√£o)</label><input type="text" id="mp-access-token" placeholder="APP_USR-xxxxxxxx..." required></div>
                        <div class="section-divider-title">Pre√ßos Renova√ß√£o (Individual)</div>
                        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px;">
                            <div><label style="font-size:0.75rem; color:#888;">Mensal (R$)</label><input type="number" id="price-monthly" step="0.01"></div>
                            <div><label style="font-size:0.75rem; color:#888;">Trimestral (R$)</label><input type="number" id="price-quarterly" step="0.01"></div>
                            <div><label style="font-size:0.75rem; color:#888;">Semestral (R$)</label><input type="number" id="price-semiannual" step="0.01"></div>
                            <div><label style="font-size:0.75rem; color:#888;">Anual (R$)</label><input type="number" id="price-yearly" step="0.01"></div>
                        </div>
                        <div class="section-divider-title">Planos Revenda (Aumento de Limite)</div>
                        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px;">
                            <div><label style="font-size:0.75rem; color:#888;">Lote 5 Bots</label><input type="number" id="price-resell-5" step="0.01"></div>
                            <div><label style="font-size:0.75rem; color:#888;">Lote 10 Bots</label><input type="number" id="price-resell-10" step="0.01"></div>
                            <div><label style="font-size:0.75rem; color:#888;">Lote 20 Bots</label><input type="number" id="price-resell-20" step="0.01"></div>
                            <div><label style="font-size:0.75rem; color:#888;">Lote 30 Bots</label><input type="number" id="price-resell-30" step="0.01"></div>
                        </div>
                        <button type="submit" class="btn-primary" style="background: var(--cyan); color: #000; margin-top: 10px;">Salvar Altera√ß√µes</button>
                    </form>
                </div>
                <div class="form-section">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h4 style="margin: 0;">Usu√°rios Cadastrados</h4>
                    </div>
                    <ul id="users-list" style="list-style: none; padding: 0;"></ul>
                </div>
            </div>

            <!-- VIEW DO USU√ÅRIO -->
            <div id="user-view">
                <div id="view-header" style="margin: 15px 0;">
                    <h2 id="main-title-text" style="font-size: 1.2rem; margin: 0;">Meus Rob√¥s</h2>
                    <p id="sub-title-text" style="color: var(--text-muted); font-size: 0.85rem; margin-top: 5px;">Aqui voc√™ cria e controla seus atendentes virtuais.</p>
                </div>
                <div class="form-section">
                    <h4 style="margin-top: 0; margin-bottom: 20px; display: flex; align-items: center; gap: 8px;"><i class="fas fa-plus-circle" style="color: var(--primary);"></i> <span id="add-bot-label">Criar Novo Rob√¥</span></h4>
                    <form id="add-bot-form">
                        <div class="input-group"><label for="sessionName" class="input-label">1. Nome de Identifica√ß√£o</label><span class="help-text">Um nome curto para voc√™ identificar este bot (ex: Loja_Centro). Sem espa√ßos.</span><input type="text" id="sessionName" required placeholder="Ex: Bot_Vendas_01"></div>
                        <div class="input-group"><label for="prompt" class="input-label">2. Personalidade do Rob√¥ <span class="example-link" onclick="fillExamplePrompt()">Ver Exemplo</span></label><span class="help-text">Explique como ele deve agir. Diga quem ele √©, o que vende e como deve responder.</span><textarea id="prompt" rows="6" required placeholder="Ex: Voc√™ √© um assistente virtual da Loja X..."></textarea></div>
                        <button type="submit" class="btn-primary" id="create-bot-btn">Salvar e Criar Rob√¥</button>
                    </form>
                </div>
                <div id="bots-grid"></div>
                <div id="user-logs-area" class="hidden" style="margin-top: 30px;">
                    <h4>Hist√≥rico de Atividades</h4>
                    <div id="user-log-content" class="logs-container" style="height: 150px; color: #ccc;"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAIS -->
    <div id="edit-modal" class="modal-overlay">
        <div class="modal-content">
            <div style="display:flex; justify-content:space-between; margin-bottom:15px;"><h3>Editar Personalidade</h3><i class="fas fa-times" onclick="closeEditModal()" style="padding:10px; cursor:pointer;"></i></div>
            <p style="color:#aaa; font-size:0.85rem; margin-bottom:10px;">Altere como o rob√¥ responde √†s mensagens.</p>
            <form id="edit-bot-form">
                <input type="hidden" id="edit-sessionName-hidden">
                <input type="text" id="edit-sessionName-display" disabled style="opacity: 0.5; margin-bottom:15px; width:100%; padding:10px; border:1px solid #333; background:#111; color:#777; border-radius:6px;">
                <textarea id="edit-prompt" rows="8" required style="font-family: sans-serif;"></textarea>
                <button type="submit" class="btn-primary" style="margin-top:10px;">Salvar Altera√ß√µes</button>
            </form>
        </div>
    </div>

    <div id="ignore-modal" class="modal-overlay">
        <div class="modal-content">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                <h3 style="margin-top:0;">Ignorar por Nome</h3>
                <i class="fas fa-times" onclick="document.getElementById('ignore-modal').style.display='none'" style="padding:10px; cursor:pointer;"></i>
            </div>
            <p class="help-text" style="margin-top:-10px; margin-bottom:15px;">O rob√¥ n√£o responder√° aos contatos com nome exato na lista. O bot ser√° reiniciado a cada altera√ß√£o.</p>
            
            <input type="hidden" id="ignore-sessionName-hidden">
            
            <form id="add-identifier-form">
                <div style="display:flex; gap:10px;">
                    <input type="text" id="new-identifier-input" required placeholder="Digite o nome completo do contato">
                    <button type="submit" class="btn-primary" style="width:auto; padding:0 20px;">Adicionar</button>
                </div>
            </form>

            <div class="section-divider-title" style="margin-top: 30px;">Atualmente Ignorados</div>
            <div id="ignored-list-container" class="list-container">
            </div>
        </div>
    </div>

    <!-- Modal Pairing Code -->
    <div id="pairing-modal" class="modal-overlay">
        <div class="modal-content">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                <h3 style="margin-top:0;">Conectar com N√∫mero</h3>
                <i class="fas fa-times" onclick="document.getElementById('pairing-modal').style.display='none'" style="padding:10px; cursor:pointer;"></i>
            </div>
            <p class="help-text" style="margin-top:-10px; margin-bottom:15px;">Digite o n√∫mero do WhatsApp que ser√° o rob√¥ (com DDD). Ex: 5511999999999</p>
            
            <input type="hidden" id="pairing-sessionName-hidden">
            
            <form id="pairing-form">
                <div class="input-group">
                    <input type="number" id="pairing-phone-number" required placeholder="5511999999999" style="text-align:center; font-size:1.2rem; letter-spacing:1px;">
                </div>
                <button type="submit" class="btn-primary">Gerar C√≥digo</button>
            </form>
        </div>
    </div>

    <!-- Modal Pay -->
    <div id="payment-modal" class="modal-overlay">
        <div class="modal-content text-center">
            <i class="fas fa-times" onclick="closePaymentModal()" style="position:absolute; right:20px; top:20px; padding:10px; cursor:pointer;"></i>
            <h3 style="color: var(--cyan);">Renovar Acesso</h3>
            <p style="font-size: 0.9rem; color: #aaa; margin-bottom: 20px;">Rob√¥: <strong id="pay-session-name" style="color: white;"></strong></p>
            
            <div id="pay-step-select">
                <p style="color:#e1e1e6; margin-bottom:15px; font-weight:600;">Por quanto tempo deseja renovar?</p>
                <div id="plans-container"></div>
            </div>

            <div id="pix-loading" class="hidden payment-success-container" style="padding: 40px 0;">
                <i class="fas fa-circle-notch fa-spin fa-2x" style="color: var(--cyan);"></i>
                <p style="margin-top: 15px;">Gerando c√≥digo Pix...</p>
            </div>

            <div id="pix-content" class="hidden payment-success-container">
                <h2 id="pay-amount" class="amount-display">R$ --</h2>
                
                <div class="qr-wrapper">
                    <img id="pix-qrcode-display" src="" style="width: 180px; display: block;">
                </div>

                <div class="copy-row">
                    <input type="text" id="pix-copy-paste" readonly class="input-copy">
                    <button onclick="copyPixCode('pix-copy-paste')" class="btn-copy" style="background: var(--cyan);">Copiar</button>
                </div>

                <button onclick="sharePixPayment('individual')" class="btn-share-pix">
                    <i class="fas fa-share-alt"></i> Compartilhar Pagamento
                </button>

                <p style="color: var(--green); font-size: 0.8rem; margin-top: 15px;"><i class="fas fa-check-circle"></i> Libera√ß√£o Autom√°tica ap√≥s pagamento</p>
                <button onclick="resetPaymentModal()" style="background:transparent; color:#888; border:1px solid #333; padding:8px 20px; border-radius:20px; margin-top:10px; font-size:0.8rem;">Voltar</button>
            </div>
        </div>
    </div>

    <!-- Modal REVENDA -->
    <div id="resell-modal" class="modal-overlay">
        <div class="modal-content text-center">
            <i class="fas fa-times" onclick="document.getElementById('resell-modal').style.display='none'" style="position:absolute; right:20px; top:20px; padding:10px; cursor:pointer;"></i>
            <h3 style="color: var(--primary);">Aumente seu Limite!</h3>
            <p style="font-size: 0.9rem; color: #aaa; margin-bottom: 20px;">Limite atual: <strong><span id="current-limit-display-modal">1</span></strong> rob√¥(s).</p>
            
            <div id="resell-step-select">
                <div id="resell-plans-container"></div>
            </div>
            
            <div id="resell-pix-loading" class="hidden payment-success-container" style="padding: 40px 0;">
                <i class="fas fa-circle-notch fa-spin fa-2x" style="color: var(--primary);"></i>
                <p style="margin-top: 10px;">Gerando Pix...</p>
            </div>

            <div id="resell-pix-content" class="hidden payment-success-container">
                <h2 id="resell-pay-amount" class="amount-display">R$ --</h2>
                
                <div class="qr-wrapper">
                    <img id="resell-qrcode-display" src="" style="width: 180px; display: block;">
                </div>

                <div class="copy-row">
                    <input type="text" id="resell-copy-paste" readonly class="input-copy">
                    <button onclick="copyPixCode('resell-copy-paste')" class="btn-copy">Copiar</button>
                </div>

                <button onclick="sharePixPayment('resell')" class="btn-share-pix">
                    <i class="fas fa-share-alt"></i> Compartilhar Pagamento
                </button>

                <p style="color: var(--green); font-size: 0.8rem; margin-top: 15px;">Limite atualizado automaticamente!</p>
            </div>
        </div>
    </div>

    <!-- BOT√ÉO DE SUPORTE -->
    <a href="https://wa.me/5511956087683" target="_blank" class="btn-support" title="Falar com Suporte">
        <i class="fab fa-whatsapp"></i>
    </a>

    <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
    <script>
        let socket;
        let currentUser = {}; 
        let botsData = {}; 
        let viewedUser = null;
        let publicPrices = {};

        document.addEventListener('DOMContentLoaded', async () => {
            
            if ('serviceWorker' in navigator) {
                const updateBar = document.getElementById('pwa-update-bar');
                const updateBtn = document.getElementById('pwa-update-btn');
                let newWorker;

                navigator.serviceWorker.register('/sw.js').then(reg => {
                    reg.addEventListener('updatefound', () => {
                        newWorker = reg.installing;
                        newWorker.addEventListener('statechange', () => {
                            if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                updateBar.classList.add('show');
                            }
                        });
                    });
                });

                updateBtn.addEventListener('click', () => {
                    newWorker.postMessage({ type: 'SKIP_WAITING' });
                });

                let refreshing;
                navigator.serviceWorker.addEventListener('controllerchange', () => {
                    if (refreshing) return;
                    window.location.reload();
                    refreshing = true;
                });
            }

            const urlParams = new URLSearchParams(window.location.search);
            if(urlParams.has('error')) {
                const errorMsg = urlParams.get('error');
                // CORRE√á√ÉO: Filtra "Bad Request" para n√£o assustar o usu√°rio
                if(errorMsg && errorMsg.trim() !== "" && errorMsg.toLowerCase() !== 'bad request') {
                    showFeedback(false, errorMsg);
                }
                window.history.replaceState({}, document.title, "/");
            }

            try {
                const response = await fetch('/check-session');
                const data = await response.json();
                if (response.ok && data.loggedIn) {
                    enterDashboard(data.user);
                }
            } catch (e) { console.log("Sess√£o expirada ou n√£o logado."); }
        });

        function enterDashboard(user) {
            document.getElementById('auth-section').style.display = 'none';
            document.getElementById('dashboard-container').classList.remove('hidden');
            document.getElementById('user-display-name').textContent = user.username;
            initializeSocket();
        }

        function toggleAuthForms() {
            const login = document.getElementById('login-form-container');
            const register = document.getElementById('register-form-container');
            if(login.classList.contains('hidden')) {
                login.classList.remove('hidden'); register.classList.add('hidden');
            } else {
                login.classList.add('hidden'); register.classList.remove('hidden');
            }
        }

        async function handleAuth(url, body, btnId) {
            const btn = document.getElementById(btnId);
            const originalText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processando...';

            try {
                const res = await fetch(url, { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify(body)});
                const data = await res.json();
                
                if (res.ok) {
                    if (url === '/login') {
                        window.location.reload();
                    } else { 
                        toggleAuthForms(); 
                        document.getElementById('login-username').value = body.username; 
                        showFeedback(true, 'Conta criada! Agora fa√ßa login.'); 
                    }
                } else {
                    showFeedback(false, data.message || 'Ocorreu um erro.');
                }
            } catch (error) { 
                showFeedback(false, 'Erro de conex√£o com o servidor.'); 
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        }

        document.getElementById('login-form').onsubmit = (e) => { 
            e.preventDefault(); 
            handleAuth('/login', { 
                username: document.getElementById('login-username').value, 
                password: document.getElementById('login-password').value 
            }, 'btn-login-submit'); 
        };

        document.getElementById('register-form').onsubmit = (e) => { 
            e.preventDefault(); 
            handleAuth('/register', { 
                username: document.getElementById('register-username').value, 
                password: document.getElementById('register-password').value 
            }, 'btn-register-submit'); 
        };

        function showFeedback(success, msg) {
            const feedbackArea = document.getElementById('feedback-area');
            feedbackArea.textContent = msg;
            feedbackArea.className = success ? 'feedback-success' : 'feedback-error';
            feedbackArea.style.display = 'block';
            setTimeout(() => feedbackArea.style.display = 'none', 4000);
        }

        function fillExamplePrompt() {
            const example = "Voc√™ √© o assistente virtual da Pizzaria. \n1. Seja educado.\n2. Card√°pio: Pizza Queijo (R$30), Pizza Frango (R$35).";
            document.getElementById('prompt').value = example;
        }

        function confirmLogout() {
            if (confirm('Tem certeza que deseja sair do painel?')) {
                window.location.href = '/logout';
            }
        }

        function initializeSocket() {
            if (socket && socket.connected) return;
            socket = io();

            socket.on('session-info', (data) => {
                currentUser = data;
                updateUserLimitUI(data.botLimit || 1);

                if (currentUser.isAdmin) {
                    document.getElementById('admin-panel').classList.remove('hidden');
                    document.getElementById('user-view').classList.add('hidden');
                    socket.emit('admin-get-users');
                    socket.emit('admin-settings');
                } else {
                    document.getElementById('admin-panel').classList.add('hidden');
                    document.getElementById('user-view').classList.remove('hidden');
                    socket.emit('get-my-bots');
                }
                socket.emit('get-public-prices');
            });

            socket.on('update-limit', (newLimit) => {
                currentUser.botLimit = newLimit;
                updateUserLimitUI(newLimit);
                document.getElementById('resell-modal').style.display = 'none';
                showFeedback(true, `Parab√©ns! Seu limite agora √© de ${newLimit} rob√¥s!`);
            });

            socket.on('initial-bots-list', (bots) => { document.getElementById('bots-grid').innerHTML = ''; botsData = {}; bots.forEach(renderBotCard); });
            socket.on('bot-updated', (bot) => { 
                if (!currentUser.isAdmin && bot.owner !== currentUser.username) return;
                if (currentUser.isAdmin && viewedUser && bot.owner !== viewedUser) return;
                
                if (currentUser.isAdmin && !viewedUser && bot.owner === currentUser.username) {
                } else if (currentUser.isAdmin && !viewedUser && bot.owner !== currentUser.username) {
                    return; 
                }

                const btn = document.getElementById('create-bot-btn');
                if(btn.disabled && document.getElementById(`bot-${bot.sessionName}`)) {
                    btn.disabled = false;
                    btn.innerHTML = 'Salvar e Criar Rob√¥';
                }
                renderBotCard(bot); 
            });
            socket.on('bot-deleted', (d) => { const el = document.getElementById(`bot-${d.sessionName}`); if(el) el.remove(); });
            socket.on('log-message', (d) => {
                const c = document.querySelector(`#bot-${d.sessionName} .logs-container`);
                if(c && !d.message.startsWith('QR_CODE:') && !d.message.startsWith('PAIRING_CODE:')) {
                    const l = document.createElement('div'); l.className='log-line'; l.textContent = `> ${d.message}`;
                    c.appendChild(l); c.scrollTop = c.scrollHeight;
                    sessionStorage.setItem(`log-${d.sessionName}`, c.innerHTML);
                }
            });
            socket.on('admin-users-list', (users) => {
                const list = document.getElementById('users-list'); list.innerHTML = '';
                users.forEach(u => {
                    const li = document.createElement('li'); li.className = 'user-list-item';
                    li.style.borderBottom = "1px solid #333"; li.style.padding = "10px 0"; li.style.display="flex"; li.style.justifyContent="space-between";
                    li.innerHTML = `
                        <div style="display:flex; flex-direction:column;">
                            <span style="font-weight:600; font-size:0.9rem;">${u.username}</span>
                            <span style="font-size:0.75rem; color:#888;">${u.isAdmin ? 'Administrador' : `Limite: ${u.botLimit || 1} bots`} | ID: ${u.username}</span>
                        </div>
                        ${!u.isAdmin ? `<i class="fas fa-trash" style="color:var(--red); cursor:pointer; padding:5px;" onclick="delUser(event, '${u.username}')"></i>` : ''}
                    `;
                    li.onclick = (e) => { if(e.target.tagName !== 'I') openAdminUserView(u); };
                    list.appendChild(li);
                });
            });
            
            socket.on('admin-settings', (s) => { 
                document.getElementById('mp-access-token').value = s.mpAccessToken || ''; 
                document.getElementById('price-monthly').value = s.priceMonthly || '';
                document.getElementById('price-quarterly').value = s.priceQuarterly || '';
                document.getElementById('price-semiannual').value = s.priceSemiannual || '';
                document.getElementById('price-yearly').value = s.priceYearly || '';
                
                document.getElementById('price-resell-5').value = s.priceResell5 || '';
                document.getElementById('price-resell-10').value = s.priceResell10 || '';
                document.getElementById('price-resell-20').value = s.priceResell20 || '';
                document.getElementById('price-resell-30').value = s.priceResell30 || '';
            });

            socket.on('public-prices', (prices) => { publicPrices = prices; });

            socket.on('payment-success', (d) => { 
                if(document.getElementById('payment-modal').style.display !== 'none') {
                   if(document.getElementById('pay-session-name').innerText === d.sessionName) {
                       closePaymentModal(); showFeedback(true, 'Pagamento Recebido! Bot Renovado.');
                   }
                }
            });

            socket.on('feedback', (d) => {
                if(!d.success && d.error === 'limit_reached') {
                    openResellModal();
                    const btn = document.getElementById('create-bot-btn');
                    btn.disabled = false; btn.innerHTML = 'Salvar e Criar Rob√¥';
                } else {
                    showFeedback(d.success, d.message);
                }
            });
        }

        function updateUserLimitUI(limit) {
            const display = limit > 900 ? "Ilimitado" : limit;
            document.getElementById('current-limit-display').innerText = display;
            if(document.getElementById('current-limit-display-modal')) {
                document.getElementById('current-limit-display-modal').innerText = display;
            }
        }

        function openAdminUserView(user) {
            viewedUser = user.username;
            document.getElementById('admin-panel').classList.add('hidden');
            document.getElementById('user-view').classList.remove('hidden');
            const backBtn = document.getElementById('nav-back-btn');
            backBtn.classList.remove('hidden');
            document.getElementById('nav-placeholder').classList.add('hidden');
            document.getElementById('main-title-text').textContent = user.username;
            document.getElementById('sub-title-text').textContent = `Gerenciando bots deste usu√°rio`;
            document.getElementById('add-bot-label').textContent = 'Criar Bot para este usu√°rio';
            document.getElementById('user-logs-area').classList.remove('hidden');
            const logC = document.getElementById('user-log-content'); logC.innerHTML = '';
            if(user.log) user.log.slice().reverse().forEach(l => logC.innerHTML += `<div class="log-line">${l}</div>`);
            document.getElementById('bots-grid').innerHTML = '';
            socket.emit('admin-get-bots-for-user', { username: user.username });
        }

        function goToMyBotsAdmin() {
            viewedUser = null; 
            document.getElementById('admin-panel').classList.add('hidden');
            document.getElementById('user-view').classList.remove('hidden');
            document.getElementById('nav-back-btn').classList.remove('hidden');
            document.getElementById('nav-placeholder').classList.add('hidden');
            document.getElementById('main-title-text').textContent = "Meus Rob√¥s (Admin)";
            document.getElementById('sub-title-text').textContent = "Cria√ß√£o de bots ilimitada para administra√ß√£o.";
            document.getElementById('add-bot-label').textContent = 'Criar Novo Rob√¥';
            document.getElementById('user-logs-area').classList.remove('hidden');
            document.getElementById('bots-grid').innerHTML = '';
            socket.emit('get-my-bots');
        }

        function goBackToAdminHome() {
            viewedUser = null;
            document.getElementById('user-view').classList.add('hidden');
            document.getElementById('admin-panel').classList.remove('hidden');
            document.getElementById('nav-back-btn').classList.add('hidden');
            document.getElementById('nav-placeholder').classList.remove('hidden');
            document.getElementById('bots-grid').innerHTML = '';
        }

        function formatDate(isoString) {
            if (!isoString) return 'N/A';
            const date = new Date(isoString);
            if (isNaN(date)) return 'Data inv√°lida';
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const year = date.getFullYear();
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            return `${day}/${month}/${year} ${hours}:${minutes}`;
        }

        function renderBotCard(bot) {
            botsData[bot.sessionName] = bot;
            let card = document.getElementById(`bot-${bot.sessionName}`);
            
            let statusClass = 'st-offline'; let icon = 'fa-power-off'; let txt = "Desligado";
            let timeText = 'Aguardando Ativa√ß√£o';
            let pct = 0;
            let isExpired = false;
            let daysForInput = 0;

            if(!bot.activated) {
                statusClass = 'st-inactive'; icon='fa-hourglass-start'; txt='Aguardando QR';
                timeText = 'Aguardando leitura do QR Code';
            } else {
                const now = new Date();
                const expireDate = new Date(bot.trialExpiresAt);
                const totalDuration = 31 * 24 * 60 * 60 * 1000;
                const timeLeft = expireDate - now;
                
                daysForInput = Math.ceil(timeLeft / (1000 * 60 * 60 * 24));
                if (daysForInput < 0) daysForInput = 0;

                isExpired = timeLeft <= 0;
                
                if (bot.isTrial && !isExpired) {
                    pct = 100; 
                    timeText = 'Teste Gr√°tis Ativo';
                } else {
                    const daysLeft = Math.ceil(timeLeft / (1000 * 60 * 60 * 24));
                    pct = Math.max(0, Math.min(100, (timeLeft/totalDuration)*100));
                    timeText = isExpired ? 'Plano Expirado' : `${daysLeft} dias restantes`;
                }
                
                if(bot.status === 'Online') { statusClass='st-online'; icon='fa-check'; txt='Conectado'; }
                else if(bot.status.includes('Iniciando')) { statusClass='st-starting'; icon='fa-sync fa-spin'; txt='Iniciando...'; }
                else if(bot.status.includes('Aguardando')) { statusClass='st-waiting'; icon='fa-qrcode'; txt='Ler QR Code'; }
                else if(isExpired) { statusClass='st-expired'; icon='fa-times'; txt='Expirado'; }
            }

            const adminTools = currentUser.isAdmin ? `
                <div class="admin-tools">
                    <span>ADMIN DIAS:</span>
                    <div style="display:flex; gap:10px; align-items:center;">
                        <div class="counter-wrapper">
                            <button class="counter-btn" onclick="modDays('${bot.sessionName}', -1)"><i class="fas fa-minus"></i></button>
                            <input type="number" id="d-${bot.sessionName}" class="days-input" value="${daysForInput}">
                            <button class="counter-btn" onclick="modDays('${bot.sessionName}', 1)"><i class="fas fa-plus"></i></button>
                        </div>
                        <button class="btn-save-days" onclick="admSaveDays('${bot.sessionName}')" title="Salvar"><i class="fas fa-save"></i></button>
                    </div>
                </div>
            ` : '';

            let qrSection = '';
            if (bot.status === 'Aguardando QR Code') {
                if (bot.qr && bot.qr.startsWith('PAIRING_CODE:')) {
                    const code = bot.qr.replace('PAIRING_CODE:', '');
                    qrSection = `
                        <div class="qr-area">
                            <div class="qr-instructions">
                                <strong>Conectar com C√≥digo:</strong>
                                <ol>
                                    <li>No WhatsApp > Aparelhos Conectados</li>
                                    <li>Conectar um aparelho</li>
                                    <li>Toque em "Conectar com n√∫mero de telefone"</li>
                                </ol>
                            </div>
                            <div class="pairing-code-display">${code}</div>
                            <p style="font-size:0.8rem; color:#666;">Digite este c√≥digo no seu celular.</p>
                        </div>
                    `;
                } else {
                    qrSection = `
                        <div class="qr-area">
                            <div class="qr-instructions">
                                <strong>Conectar WhatsApp:</strong>
                                <ol><li>Abra o WhatsApp > Aparelhos Conectados</li><li>Conectar um aparelho</li></ol>
                            </div>
                            <div class="qr-tgt" id="qr-tgt-${bot.sessionName}"></div>
                            <button class="btn-share-qr" onclick="shareQrCode('${bot.sessionName}')">
                                <i class="fas fa-share-alt"></i> Compartilhar QR
                            </button>
                            <button class="btn-use-code" onclick="openPairingModal('${bot.sessionName}')">
                                <i class="fas fa-mobile-alt"></i> Conectar com N√∫mero
                            </button>
                        </div>
                    `;
                }
            }

            let toggleBtnHtml = '';
            const isRunning = bot.status === 'Online' || bot.status.includes('Iniciando') || bot.status.includes('Aguardando');

            if (isRunning) {
                toggleBtnHtml = `<button class="icon-btn btn-act-stop" onclick="sock('stop-bot','${bot.sessionName}')"><i class="fas fa-stop"></i><span>Desligar</span></button>`;
            } else {
                toggleBtnHtml = `<button class="icon-btn btn-act-start" onclick="sock('start-bot','${bot.sessionName}')"><i class="fas fa-play"></i><span>Iniciar</span></button>`;
            }

            const html = `
                <div class="card-header">
                    <div style="display:flex; align-items:center; gap:8px;"><i class="fas fa-robot" style="color:var(--primary);"></i><span style="font-weight:600;">${bot.sessionName}</span></div>
                    <div class="status-badge ${statusClass}"><i class="fas ${icon}"></i> ${txt}</div>
                </div>
                <div class="card-body">
                    <div class="progress-container">
                        <div class="progress-info">
                            <span>Status</span><span style="color:${isExpired ? 'var(--red)' : 'var(--text-main)'}">${timeText}</span>
                        </div>
                        <div class="progress-bar-bg"><div class="progress-bar-fill" style="width:${pct}%; background:${isExpired ? 'var(--red)' : 'var(--primary)'}"></div></div>
                    </div>
                    
                    <div style="border-top: 1px solid var(--border); margin-top: 10px; padding-top: 10px;">
                        <div class="date-info">
                            <span>Criado em:</span>
                            <strong>${formatDate(bot.createdAt)}</strong>
                        </div>
                        <div class="date-info">
                            <span>Vence em:</span>
                            <strong style="color: ${isExpired ? 'var(--red)' : 'var(--text-main)'}">${formatDate(bot.trialExpiresAt)}</strong>
                        </div>
                    </div>

                    ${qrSection}
                    <div class="logs-container">
                        <div style="display:flex; justify-content:space-between; margin-bottom:5px; color:#666;">
                            <span>TERMINAL</span> <span onclick="clearLogs('${bot.sessionName}')" style="cursor:pointer; font-size:0.65rem; text-decoration:underline;">Limpar</span>
                        </div>
                    </div>
                    <div class="action-grid">
                        ${toggleBtnHtml}
                        <button class="icon-btn" onclick="openEdit('${bot.sessionName}')"><i class="fas fa-pen"></i><span>Editar</span></button>
                        <button class="icon-btn" onclick="openIgnoreModal('${bot.sessionName}')"><i class="fas fa-user-slash"></i><span>Ignorar</span></button>
                        <button class="icon-btn btn-act-pay" onclick="openPay('${bot.sessionName}')"><i class="fas fa-bolt"></i><span>Renovar</span></button>
                        <button class="icon-btn" onclick="delBot('${bot.sessionName}')"><i class="fas fa-trash"></i> <span>Excluir</span></button>
                    </div>
                    ${adminTools}
                </div>
            `;

            if(!card) {
                card = document.createElement('div'); card.className = 'bot-card'; card.id = `bot-${bot.sessionName}`;
                document.getElementById('bots-grid').prepend(card);
            }
            card.innerHTML = html;

            const svLogs = sessionStorage.getItem(`log-${bot.sessionName}`);
            const logC = card.querySelector('.logs-container');
            if(svLogs) { 
                const h = logC.firstElementChild.outerHTML; logC.innerHTML = h + svLogs.replace(/<div.*?TERMINAL.*?<\/div>/, ''); logC.scrollTop=logC.scrollHeight; 
            }
            if(bot.status === 'Aguardando QR Code' && bot.qr && !bot.qr.startsWith('PAIRING_CODE:')) {
                const qt = card.querySelector(`#qr-tgt-${bot.sessionName}`); 
                if(qt) { qt.innerHTML=''; new QRCode(qt, {text:bot.qr, width:180, height:180}); }
            }
        }

        function dataURItoBlob(dataURI) {
            var byteString;
            if (dataURI.split(',')[0].indexOf('base64') >= 0)
                byteString = atob(dataURI.split(',')[1]);
            else
                byteString = unescape(dataURI.split(',')[1]);

            var mimeString = dataURI.split(',')[0].split(':')[1].split(';')[0];

            var ia = new Uint8Array(byteString.length);
            for (var i = 0; i < byteString.length; i++) {
                ia[i] = byteString.charCodeAt(i);
            }

            return new Blob([ia], {type:mimeString});
        }

        async function shareQrCode(sessionName) {
            const card = document.getElementById(`bot-${sessionName}`);
            const container = card.querySelector(`#qr-tgt-${sessionName}`);
            
            if (!container) {
                showFeedback(false, 'QR Code n√£o encontrado.');
                return;
            }

            let sourceUrl = '';
            const canvasEl = container.querySelector('canvas');
            const imgEl = container.querySelector('img');

            if (canvasEl) {
                sourceUrl = canvasEl.toDataURL('image/png');
            } else if (imgEl && imgEl.src) {
                sourceUrl = imgEl.src;
            } else {
                showFeedback(false, 'Imagem QR CODE ainda n√£o gerada.');
                return;
            }

            try {
                const tempImg = new Image();
                tempImg.onload = async () => {
                    const size = 300; 
                    const padding = 20; 
                    
                    const cvs = document.createElement('canvas');
                    cvs.width = size;
                    cvs.height = size;
                    const ctx = cvs.getContext('2d');

                    ctx.fillStyle = '#FFFFFF';
                    ctx.fillRect(0, 0, size, size);

                    ctx.drawImage(tempImg, padding, padding, size - (padding * 2), size - (padding * 2));

                    cvs.toBlob(async (blob) => {
                        if (!blob) {
                            showFeedback(false, 'Erro ao gerar arquivo de imagem.');
                            return;
                        }

                        const file = new File([blob], `qrcode_${sessionName}.png`, { type: "image/png" });

                        if (navigator.canShare && navigator.canShare({ files: [file] })) {
                            await navigator.share({
                                title: 'ZappBot QR Code',
                                text: 'Escaneie este QR Code para conectar o bot ' + sessionName,
                                files: [file]
                            });
                        } else {
                            try {
                                const item = new ClipboardItem({ "image/png": blob });
                                await navigator.clipboard.write([item]);
                                showFeedback(true, 'Imagem copiada para a √°rea de transfer√™ncia!');
                            } catch (err) {
                                showFeedback(false, 'Seu navegador n√£o suporta compartilhamento nativo.');
                            }
                        }
                    }, 'image/png');
                };
                
                tempImg.src = sourceUrl;

            } catch (err) {
                console.error(err);
                showFeedback(false, 'Erro ao compartilhar: ' + err.message);
            }
        }

        async function sharePixPayment(type) {
            const imgId = type === 'resell' ? 'resell-qrcode-display' : 'pix-qrcode-display';
            const textId = type === 'resell' ? 'resell-copy-paste' : 'pix-copy-paste';

            const img = document.getElementById(imgId);
            const textCode = document.getElementById(textId).value;

            if (!img.src || !textCode) {
                showFeedback(false, 'Informa√ß√µes de pagamento n√£o encontradas.');
                return;
            }

            try {
                const blob = await (await fetch(img.src)).blob();
                const file = new File([blob], "pix_pagamento.png", { type: "image/png" });

                if (navigator.canShare && navigator.canShare({ files: [file] })) {
                    await navigator.share({
                        title: 'Pagamento Pix ZappBot',
                        text: 'Aqui est√° o c√≥digo Pix Copia e Cola:\n\n' + textCode,
                        files: [file]
                    });
                } else {
                    copyPixCode(textId);
                    alert('Compartilhamento de arquivo n√£o suportado neste navegador. O c√≥digo Pix foi copiado para sua √°rea de transfer√™ncia!');
                }
            } catch (err) {
                console.error(err);
                copyPixCode(textId);
                showFeedback(true, 'C√≥digo copiado! (Compartilhamento falhou)');
            }
        }

        function openPairingModal(sessionName) {
            document.getElementById('pairing-sessionName-hidden').value = sessionName;
            document.getElementById('pairing-modal').style.display = 'flex';
        }

        document.getElementById('pairing-form').onsubmit = (e) => {
            e.preventDefault();
            const sessionName = document.getElementById('pairing-sessionName-hidden').value;
            const phoneNumber = document.getElementById('pairing-phone-number').value;
            
            socket.emit('stop-bot', { sessionName });
            
            setTimeout(() => {
                socket.emit('start-bot', { sessionName, phoneNumber });
                document.getElementById('pairing-modal').style.display = 'none';
                showFeedback(true, 'Solicitando c√≥digo de pareamento...');
            }, 1000);
        };

        function sock(ev, name) { socket.emit(ev, { sessionName: name }); }
        function delBot(n) { if(confirm('Apagar "'+n+'"?')) sock('delete-bot', n); }
        function modDays(sessionName, delta) { const input = document.getElementById(`d-${sessionName}`); let val = parseInt(input.value)||0; val+=delta; input.value=val; }
        function admSaveDays(sessionName) { socket.emit('admin-set-days', { sessionName: sessionName, days: document.getElementById(`d-${sessionName}`).value }); }
        function delUser(e, u) { e.stopPropagation(); if(confirm('Apagar usu√°rio '+u+'?')) socket.emit('admin-delete-user', {username:u}); }
        function clearLogs(n) { sessionStorage.removeItem(`log-${n}`); document.querySelector(`#bot-${n} .logs-container`).innerHTML='<div style="display:flex; justify-content:space-between; margin-bottom:5px; color:#666;"><span>TERMINAL</span><span onclick="clearLogs(\''+n+'\')" style="cursor:pointer; font-size:0.65rem; text-decoration:underline;">Limpar</span></div>'; }
        
        function openEdit(n) {
            document.getElementById('edit-modal').style.display='flex';
            document.getElementById('edit-sessionName-hidden').value=n;
            document.getElementById('edit-sessionName-display').value=n;
            document.getElementById('edit-prompt').value=botsData[n].prompt;
        }
        function closeEditModal() { document.getElementById('edit-modal').style.display='none'; }
        document.getElementById('edit-bot-form').onsubmit = (e) => { e.preventDefault(); sock('update-bot', { sessionName:document.getElementById('edit-sessionName-hidden').value, newPrompt:document.getElementById('edit-prompt').value }); closeEditModal(); };

        function openIgnoreModal(sessionName) {
            const modal = document.getElementById('ignore-modal');
            document.getElementById('ignore-sessionName-hidden').value = sessionName;
            const bot = botsData[sessionName];
            renderIgnoredIdentifiers(bot.ignoredIdentifiers || []);
            document.getElementById('new-identifier-input').value = ''; 
            modal.style.display = 'flex';
        }

        function renderIgnoredIdentifiers(identifiers) {
            const container = document.getElementById('ignored-list-container');
            container.innerHTML = '';
            if (!identifiers || identifiers.length === 0) {
                container.innerHTML = '<p style="text-align:center; color:var(--text-muted); font-size:0.8rem;">Nenhum nome na lista.</p>';
            } else {
                identifiers.forEach((item, index) => {
                    const el = document.createElement('div');
                    el.className = 'ignored-item';
                    el.innerHTML = `<span>${item.value}</span><i class="fas fa-times" onclick="removeIdentifier(${index})"></i>`;
                    container.appendChild(el);
                });
            }
        }
        
        document.getElementById('add-identifier-form').onsubmit = (e) => {
            e.preventDefault();
            const sessionName = document.getElementById('ignore-sessionName-hidden').value;
            const input = document.getElementById('new-identifier-input');
            const value = input.value.trim();
            if (!value) return;
            const currentList = botsData[sessionName].ignoredIdentifiers || [];
            const isDuplicate = currentList.some(item => item.value.toLowerCase() === value.toLowerCase());
            if (isDuplicate) { showFeedback(false, 'Este nome j√° est√° na lista.'); return; }
            const newList = [...currentList, { type: 'name', value: value }];
            updateIgnoredListOnServer(sessionName, newList);
            renderIgnoredIdentifiers(newList); 
            input.value = '';
        };

        function removeIdentifier(indexToRemove) {
            const sessionName = document.getElementById('ignore-sessionName-hidden').value;
            const currentList = botsData[sessionName].ignoredIdentifiers || [];
            const newList = currentList.filter((_, index) => index !== indexToRemove);
            updateIgnoredListOnServer(sessionName, newList);
            renderIgnoredIdentifiers(newList); 
        }

        function updateIgnoredListOnServer(sessionName, newList) {
            botsData[sessionName].ignoredIdentifiers = newList; 
            socket.emit('update-ignored-identifiers', { sessionName, ignoredIdentifiers: newList });
        }

        document.getElementById('add-bot-form').onsubmit=(e)=>{
            e.preventDefault(); 
            const nInput = document.getElementById('sessionName');
            const pInput = document.getElementById('prompt');
            let n = nInput.value.trim().replace(/\s+/g,'_');
            if(n.length < 3) { alert('O nome deve ter 3 letras.'); return; }
            const o = (currentUser.isAdmin && viewedUser) ? viewedUser : currentUser.username;
            const btn = document.getElementById('create-bot-btn');
            btn.disabled = true; btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Criando...';
            socket.emit('create-bot', { sessionName:n, prompt:pInput.value.trim(), owner:o });
            nInput.value=''; pInput.value='';
        };
        
        document.getElementById('admin-settings-form').onsubmit=(e)=>{ 
            e.preventDefault(); 
            socket.emit('save-settings', { 
                mpAccessToken: document.getElementById('mp-access-token').value, 
                priceMonthly: document.getElementById('price-monthly').value,
                priceQuarterly: document.getElementById('price-quarterly').value,
                priceSemiannual: document.getElementById('price-semiannual').value,
                priceYearly: document.getElementById('price-yearly').value,
                priceResell5: document.getElementById('price-resell-5').value,
                priceResell10: document.getElementById('price-resell-10').value,
                priceResell20: document.getElementById('price-resell-20').value,
                priceResell30: document.getElementById('price-resell-30').value,
            }); 
        };

        let currentPaySession = '';
        function openPay(n) {
            currentPaySession = n;
            const m = document.getElementById('payment-modal'); 
            m.style.display='flex';
            document.getElementById('pay-session-name').innerText = n;
            const container = document.getElementById('plans-container');
            container.innerHTML = '';
            const plans = [
                { id: 'monthly', title: 'Mensal', price: publicPrices.monthly, desc: '30 dias' },
                { id: 'quarterly', title: 'Trimestral', price: publicPrices.quarterly, desc: '90 dias' },
                { id: 'semiannual', title: 'Semestral', price: publicPrices.semiannual, desc: '180 dias' },
                { id: 'yearly', title: 'Anual', price: publicPrices.yearly, desc: '365 dias' }
            ];
            plans.forEach(p => {
                const el = document.createElement('div'); el.className = 'plan-option';
                el.innerHTML = `<div><div class="plan-title">${p.title}</div><div class="plan-desc">${p.desc}</div></div><div class="plan-price">R$ ${p.price}</div>`;
                el.onclick = () => selectPlan(p.id);
                container.appendChild(el);
            });
            document.getElementById('pay-step-select').classList.remove('hidden');
            document.getElementById('pix-loading').classList.add('hidden');
            document.getElementById('pix-content').classList.add('hidden');
        }

        async function selectPlan(planType) {
            document.getElementById('pay-step-select').classList.add('hidden');
            document.getElementById('pix-loading').classList.remove('hidden');
            try {
                const res = await fetch('/api/create-payment', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({ sessionName: currentPaySession, planType: planType }) });
                const d = await res.json();
                if(res.ok) {
                    document.getElementById('pix-loading').classList.add('hidden');
                    document.getElementById('pix-content').classList.remove('hidden');
                    document.getElementById('pay-amount').innerText = `R$ ${d.amount}`;
                    document.getElementById('pix-qrcode-display').src = `data:image/png;base64,${d.qr_code_base64}`;
                    document.getElementById('pix-copy-paste').value = d.qr_code;
                } else { alert(d.error); closePaymentModal(); }
            } catch { alert('Erro conex√£o'); closePaymentModal(); }
        }

        function openResellModal() {
            const m = document.getElementById('resell-modal');
            m.style.display = 'flex';
            const container = document.getElementById('resell-plans-container');
            container.innerHTML = '';
            const resellPlans = [
                { id: 'resell_5', title: 'Pacote 5 Rob√¥s', price: publicPrices.resell5, limit: 5 },
                { id: 'resell_10', title: 'Pacote 10 Rob√¥s', price: publicPrices.resell10, limit: 10 },
                { id: 'resell_20', title: 'Pacote 20 Rob√¥s', price: publicPrices.resell20, limit: 20 },
                { id: 'resell_30', title: 'Pacote 30 Rob√¥s', price: publicPrices.resell30, limit: 30 },
            ];
            resellPlans.forEach(p => {
                const el = document.createElement('div'); el.className = 'plan-option';
                el.innerHTML = `<div><div class="plan-title">${p.title} <span class="plan-badge-resell">Revenda</span></div><div class="plan-desc">Limite de ${p.limit} bots.</div></div><div class="plan-price">R$ ${p.price}</div>`;
                el.onclick = () => selectResellPlan(p.id);
                container.appendChild(el);
            });
            document.getElementById('resell-step-select').classList.remove('hidden');
            document.getElementById('resell-pix-loading').classList.add('hidden');
            document.getElementById('resell-pix-content').classList.add('hidden');
        }

        async function selectResellPlan(planId) {
            document.getElementById('resell-step-select').classList.add('hidden');
            document.getElementById('resell-pix-loading').classList.remove('hidden');
            try {
                const res = await fetch('/api/create-payment', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({ planType: planId }) });
                const d = await res.json();
                if(res.ok) {
                    document.getElementById('resell-pix-loading').classList.add('hidden');
                    document.getElementById('resell-pix-content').classList.remove('hidden');
                    document.getElementById('resell-pay-amount').innerText = `R$ ${d.amount}`;
                    document.getElementById('resell-qrcode-display').src = `data:image/png;base64,${d.qr_code_base64}`;
                    document.getElementById('resell-copy-paste').value = d.qr_code;
                } else { alert(d.error); document.getElementById('resell-modal').style.display='none'; }
            } catch { alert('Erro conex√£o'); document.getElementById('resell-modal').style.display='none'; }
        }

        function resetPaymentModal() { openPay(currentPaySession); }
        function copyPixCode(id) { const el=document.getElementById(id); el.select(); navigator.clipboard.writeText(el.value); showFeedback(true, 'C√≥digo Pix Copiado!'); }
        function closePaymentModal() { document.getElementById('payment-modal').style.display='none'; }
        window.onclick = (e) => { if(e.target.className === 'modal-overlay') e.target.style.display='none'; };
    </script>
</body>
</html>

