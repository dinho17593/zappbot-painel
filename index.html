
<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Painel ZappBot</title>
    
    <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
    <meta name="theme-color" content="#121214">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="ZappBot">
    
    <link rel="apple-touch-icon" href="icon-192.png">
    <link rel="icon" type="image/png" href="icon-192.png">
    <link rel="shortcut icon" href="icon-192.png" type="image/x-icon">
    <link rel="manifest" href="/manifest.json">

    <script src="/socket.io/socket.io.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
    @import url('https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap');

    :root {
        --bg-body: #09090b;
        --bg-card: #18181b; 
        --bg-input: #09090b;
        --bg-sidebar: rgba(24, 24, 27, 0.85); 
        
        --text-main: #f4f4f5;
        --text-muted: #a1a1aa;
        --border: rgba(255, 255, 255, 0.08); 
        
        --primary: #6366f1; 
        --primary-hover: #818cf8; 
        --primary-glow: rgba(99, 102, 241, 0.4);

        --purple-dark: #2e1065;   
        
        --green: #10b981;
        --red: #f43f5e;
        --blue: #3b82f6;
        --telegram-blue: #229ED9;
        --whatsapp-green: #25D366;
        --yellow: #f59e0b;
        --cyan: #06b6d4;
        
        --header-height: 70px;
        --radius-sm: 8px;
        --radius-md: 12px;
        --radius-lg: 24px;
    }

    * { 
        box-sizing: border-box; 
        outline: none; 
        -webkit-tap-highlight-color: transparent; 
    }

    ::-webkit-scrollbar { width: 6px; height: 6px; }
    ::-webkit-scrollbar-track { background: var(--bg-body); }
    ::-webkit-scrollbar-thumb { background: #3f3f46; border-radius: 10px; }
    ::-webkit-scrollbar-thumb:hover { background: #52525b; }

    body { 
        font-family: 'Plus Jakarta Sans', 'Inter', sans-serif; 
        background-color: var(--bg-body); 
        background-image: radial-gradient(circle at 50% 0%, rgba(99, 102, 241, 0.08) 0%, transparent 50%);
        color: var(--text-main); 
        margin: 0; 
        padding-bottom: 80px; 
        overflow-x: hidden; 
        line-height: 1.6;
        -webkit-font-smoothing: antialiased;
    }
    
    #pwa-update-bar {
        display: none;
        position: fixed;
        bottom: 30px;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(24, 24, 27, 0.9);
        backdrop-filter: blur(12px);
        border: 1px solid var(--border);
        color: var(--text-main);
        padding: 12px 24px;
        border-radius: 50px;
        z-index: 9999;
        box-shadow: 0 20px 40px rgba(0,0,0,0.6);
        align-items: center;
        gap: 20px;
        font-weight: 500;
        width: auto;
        min-width: 300px;
        justify-content: space-between;
    }
    #pwa-update-bar.show { display: flex; animation: slideUpFade 0.5s cubic-bezier(0.16, 1, 0.3, 1); }
    #pwa-update-btn {
        background: var(--text-main);
        color: var(--bg-body);
        border: none;
        padding: 8px 16px;
        border-radius: 20px;
        font-weight: 700;
        cursor: pointer;
        font-size: 0.8rem;
        transition: transform 0.2s;
    }
    #pwa-update-btn:hover { transform: scale(1.05); }

    .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
    .hidden { display: none !important; }
    .text-truncate { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    
    .input-group { margin-bottom: 25px; position: relative; } 
    
    .input-label { 
        display: flex; 
        justify-content: space-between; 
        align-items: center; 
        margin-bottom: 10px; 
        font-weight: 600; 
        font-size: 0.9rem; 
        color: var(--text-main); 
        letter-spacing: 0.02em;
    }
    .help-text { font-size: 0.8rem; color: var(--text-muted); margin-bottom: 10px; display: block; line-height: 1.5; }
    .example-link { color: var(--primary); cursor: pointer; font-size: 0.8rem; text-decoration: none; font-weight: 600; transition: 0.2s; }
    .example-link:hover { color: var(--primary-hover); text-decoration: underline; }

    input, textarea, select { 
        width: 100%; 
        padding: 16px; 
        background: rgba(255,255,255,0.03); 
        border: 1px solid var(--border); 
        border-radius: var(--radius-md); 
        color: var(--text-main); 
        font-size: 0.95rem; 
        font-family: 'Plus Jakarta Sans', sans-serif; 
        transition: all 0.3s ease;
    }
    input:focus, textarea:focus, select:focus { 
        border-color: var(--primary); 
        background: rgba(255,255,255,0.05);
        box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.15); 
    }
    input::placeholder { color: #52525b; }

    header { 
        position: sticky; 
        top: 0; 
        z-index: 100; 
        background: rgba(9, 9, 11, 0.7); 
        backdrop-filter: blur(20px); 
        -webkit-backdrop-filter: blur(20px);
        border-bottom: 1px solid var(--border); 
    }
    .nav-bar { 
        height: var(--header-height); 
        display: flex; 
        align-items: center; 
        justify-content: space-between; 
        padding: 0 20px; 
        position: relative; 
        max-width: 1200px;
        margin: 0 auto;
    }
    
    .nav-btn { 
        background: transparent; 
        border: 1px solid transparent; 
        color: var(--text-muted); 
        font-size: 1.2rem; 
        padding: 0; 
        cursor: pointer; 
        border-radius: 12px; 
        width: 42px; 
        height: 42px; 
        display: flex; 
        align-items: center; 
        justify-content: center; 
        transition: all 0.2s; 
        text-decoration: none; 
    }
    .nav-btn:hover { background: rgba(255,255,255,0.05); color: var(--text-main); border-color: var(--border); }
    .nav-btn:active { transform: scale(0.95); }
    .nav-btn.logout:hover { background: rgba(244, 63, 94, 0.1); color: var(--red); border-color: rgba(244, 63, 94, 0.2); }
    
    .brand-center { 
        position: absolute; 
        left: 50%; 
        top: 50%; 
        transform: translate(-50%, -50%); 
        font-size: 1.3rem; 
        font-family: 'Outfit', sans-serif;
        font-weight: 700; 
        color: var(--text-main); 
        display: flex; 
        align-items: center; 
        gap: 10px; 
        white-space: nowrap; 
        letter-spacing: -0.03em;
    }
    .brand-center i { color: var(--primary); filter: drop-shadow(0 0 8px var(--primary-glow)); }
    
    .user-strip { 
        background: rgba(255,255,255,0.02); 
        border-bottom: 1px solid var(--border); 
        padding: 10px 20px; 
        text-align: center; 
        font-size: 0.85rem; 
        color: var(--text-muted); 
        display: flex; 
        justify-content: center; 
        align-items: center; 
        gap: 12px; 
        backdrop-filter: blur(5px);
    }
    .limit-badge { 
        background: rgba(245, 158, 11, 0.1); 
        border: 1px solid rgba(245, 158, 11, 0.2); 
        padding: 4px 12px; 
        border-radius: 20px; 
        font-size: 0.75rem; 
        color: var(--yellow); 
        cursor: pointer; 
        display: flex; 
        align-items: center; 
        gap: 6px; 
        font-weight: 600;
        transition: 0.2s;
    }
    .limit-badge:hover { background: rgba(245, 158, 11, 0.2); }

    .sidebar-overlay {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.6); z-index: 1000; display: none;
        backdrop-filter: blur(4px);
        transition: opacity 0.3s;
    }
    .sidebar {
        position: fixed; top: 0; left: -320px; width: 300px; height: 100%;
        background: var(--bg-sidebar); 
        border-right: 1px solid var(--border);
        z-index: 1001; transition: cubic-bezier(0.4, 0, 0.2, 1) 0.4s;
        display: flex; flex-direction: column;
        box-shadow: 10px 0 30px rgba(0,0,0,0.5);
        backdrop-filter: blur(20px);
    }
    .sidebar.open { left: 0; }
    .sidebar-header {
        padding: 25px; border-bottom: 1px solid var(--border);
        display: flex; justify-content: space-between; align-items: center;
    }
    .sidebar-content { padding: 20px; overflow-y: auto; flex: 1; display: flex; flex-direction: column; gap: 8px; }
    .sidebar-title { font-size: 1.2rem; font-family: 'Outfit', sans-serif; font-weight: 700; color: var(--text-main); }
    
    .sidebar-btn {
        background: transparent;
        border: 1px solid transparent;
        color: var(--text-muted);
        padding: 14px 18px;
        text-align: left;
        font-size: 0.95rem;
        font-weight: 500;
        cursor: pointer;
        border-radius: var(--radius-md);
        transition: all 0.2s;
        display: flex;
        align-items: center;
        gap: 14px;
    }
    .sidebar-btn:hover {
        background: rgba(255,255,255,0.04);
        color: var(--text-main);
        transform: translateX(5px);
    }
    .sidebar-btn.active {
        background: rgba(99, 102, 241, 0.1);
        color: var(--primary);
        border: 1px solid rgba(99, 102, 241, 0.2);
        font-weight: 600;
    }
    .sidebar-btn i { width: 20px; text-align: center; }

    button { cursor: pointer; font-family: 'Plus Jakarta Sans', sans-serif; border: none; }
    
    .btn-primary { 
        background: var(--primary); 
        background: linear-gradient(135deg, var(--primary) 0%, #4f46e5 100%);
        color: white; 
        padding: 16px; 
        border-radius: var(--radius-md); 
        font-weight: 600; 
        width: 100%; 
        font-size: 1rem; 
        display: flex; 
        align-items: center; 
        justify-content: center; 
        gap: 10px; 
        box-shadow: 0 4px 20px rgba(79, 70, 229, 0.3); 
        transition: all 0.3s ease; 
        position: relative;
        overflow: hidden;
    }
    .btn-primary:hover { 
        box-shadow: 0 8px 25px rgba(79, 70, 229, 0.5); 
        transform: translateY(-2px);
    }
    .btn-primary:active { transform: scale(0.98) translateY(0); }
    .btn-primary:disabled { background: #27272a; color: #52525b; cursor: not-allowed; box-shadow: none; transform: none; }

    .btn-google { 
        background: white; 
        color: #18181b; 
        width: 100%; 
        padding: 14px; 
        border-radius: var(--radius-md); 
        font-weight: 600; 
        display: flex; 
        align-items: center; 
        justify-content: center; 
        gap: 12px; 
        text-decoration: none; 
        transition: all 0.2s; 
        border: 1px solid #e4e4e7; 
    }
    .btn-google:hover { background: #f4f4f5; transform: translateY(-1px); }
    .btn-google svg { width: 20px; height: 20px; }
    
    .auth-divider { position: relative; margin: 30px 0; text-align: center; }
    .auth-divider span { background: var(--bg-card); padding: 0 15px; color: var(--text-muted); font-size: 0.85rem; position: relative; z-index: 1; font-weight: 500; }
    .auth-divider::before { content: ''; position: absolute; top: 50%; left: 0; width: 100%; height: 1px; background: var(--border); z-index: 0; }

    .auth-wrapper { 
        display: flex; 
        justify-content: center; 
        align-items: center; 
        min-height: 100vh; 
        padding: 20px; 
        background: radial-gradient(circle at top, #1e1b4b 0%, #09090b 100%); 
    }
    .auth-card { 
        background: var(--bg-card); 
        padding: 40px; 
        border-radius: 24px; 
        border: 1px solid var(--border); 
        width: 100%; 
        max-width: 420px; 
        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5); 
    }

    #bots-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(340px, 1fr)); gap: 25px; margin-top: 25px; }
    
    .bot-card { 
        background: var(--bg-card); 
        border: 1px solid var(--border); 
        border-radius: 20px; 
        overflow: hidden; 
        display: flex; 
        flex-direction: column; 
        position: relative; 
        transition: all 0.3s ease;
    }
    .bot-card:hover {
        transform: translateY(-5px);
        border-color: rgba(255,255,255,0.15);
        box-shadow: 0 15px 30px rgba(0,0,0,0.3);
    }

    .card-header { 
        padding: 18px 22px; 
        background: rgba(255,255,255,0.02); 
        border-bottom: 1px solid var(--border); 
        display: flex; 
        justify-content: space-between; 
        align-items: center; 
    }
    
    .status-badge { 
        font-size: 0.7rem; 
        padding: 6px 12px; 
        border-radius: 30px; 
        font-weight: 700; 
        text-transform: uppercase; 
        display: flex; 
        align-items: center; 
        gap: 6px; 
        letter-spacing: 0.05em;
    }
    .st-online, .st-active { background: rgba(16, 185, 129, 0.1); color: var(--green); border: 1px solid rgba(16, 185, 129, 0.2); box-shadow: 0 0 10px rgba(16, 185, 129, 0.1); }
    .st-offline { background: rgba(113, 113, 122, 0.1); color: var(--text-muted); border: 1px solid rgba(113, 113, 122, 0.2); }
    .st-waiting { color: var(--blue); border: 1px solid rgba(59, 130, 246, 0.2); background: rgba(59, 130, 246, 0.1); }
    .st-expired { background: rgba(244, 63, 94, 0.1); color: var(--red); border: 1px solid rgba(244, 63, 94, 0.2); }
    .st-inactive, .st-pending { background: rgba(245, 158, 11, 0.1); color: var(--yellow); border: 1px solid rgba(245, 158, 11, 0.2); }

    .card-body { padding: 22px; flex-grow: 1; display: flex; flex-direction: column; gap: 18px; }
    
    .progress-container { position: relative; margin-top: 5px; }
    .progress-info { display: flex; justify-content: space-between; font-size: 0.85rem; margin-bottom: 8px; color: var(--text-muted); font-weight: 500; }
    .progress-bar-bg { height: 8px; background: rgba(255,255,255,0.05); border-radius: 4px; overflow: hidden; }
    .progress-bar-fill { 
        height: 100%; 
        background: var(--primary); 
        border-radius: 4px; 
        transition: width 0.6s cubic-bezier(0.4, 0, 0.2, 1); 
        box-shadow: 0 0 15px var(--primary-glow); 
    }
    
    .date-info { display: flex; justify-content: space-between; font-size: 0.75rem; color: var(--text-muted); padding: 4px 0; }
    .date-info strong { color: var(--text-main); font-weight: 600; }

    .logs-container { 
        background: #000000; 
        border-radius: var(--radius-sm); 
        border: 1px solid #27272a; 
        padding: 12px; 
        font-family: 'JetBrains Mono', 'Courier New', monospace; 
        font-size: 0.75rem; 
        color: #4ade80; 
        height: 130px; 
        overflow-y: auto; 
        display: flex; 
        flex-direction: column; 
        box-shadow: inset 0 2px 10px rgba(0,0,0,0.5);
    }
    .log-line { padding: 3px 0; border-bottom: 1px solid rgba(255,255,255,0.05); opacity: 0.9; }

    .qr-area { 
        background: white; 
        padding: 20px; 
        border-radius: var(--radius-md); 
        align-self: center; 
        display: flex; 
        flex-direction: column; 
        align-items: center; 
        text-align: center; 
        width: 100%; 
        box-shadow: 0 10px 30px rgba(0,0,0,0.2);
    }
    .qr-instructions { color: #18181b; margin-bottom: 15px; font-size: 0.85rem; text-align: left; width: 100%; }
    .qr-instructions ol { padding-left: 20px; margin: 5px 0; }
    .qr-instructions li { margin-bottom: 8px; line-height: 1.4; font-weight: 500; }
    
    .btn-share-qr {
        background: var(--primary);
        color: white;
        border: none;
        padding: 12px 15px;
        border-radius: var(--radius-sm);
        margin-top: 15px;
        cursor: pointer;
        font-size: 0.9rem;
        display: flex;
        align-items: center;
        gap: 8px;
        width: 100%;
        justify-content: center;
        font-weight: 600;
        transition: all 0.2s;
    }
    .btn-share-qr:hover { background: var(--primary-hover); transform: translateY(-1px); }

    .btn-use-code {
        background: transparent;
        color: var(--primary);
        border: 1px solid var(--primary);
        padding: 10px 15px;
        border-radius: var(--radius-sm);
        margin-top: 10px;
        cursor: pointer;
        font-size: 0.85rem;
        width: 100%;
        font-weight: 600;
        transition: 0.2s;
    }
    .btn-use-code:hover { background: rgba(99, 102, 241, 0.05); }

    .pairing-code-display {
        font-size: 2rem;
        font-weight: 800;
        color: #18181b;
        letter-spacing: 4px;
        margin: 20px 0;
        background: #f4f4f5;
        padding: 15px;
        border-radius: 12px;
        border: 2px dashed #d4d4d8;
        font-family: 'Courier New', monospace;
    }

    .action-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 12px; margin-top: 15px; }
    .icon-btn { 
        background: rgba(255,255,255,0.03); 
        border-radius: 16px; 
        padding: 15px 5px; 
        color: var(--text-muted); 
        display: flex; 
        flex-direction: column; 
        align-items: center; 
        gap: 8px; 
        transition: all 0.2s; 
        border: 1px solid transparent; 
        text-decoration: none; 
    }
    .icon-btn:hover { background: rgba(255,255,255,0.08); transform: translateY(-3px); color: var(--text-main); }
    .icon-btn:active { transform: scale(0.95); }
    .icon-btn i { font-size: 1.4rem; }
    .icon-btn span { font-size: 0.7rem; font-weight: 600; }
    
    .btn-act-start:hover { color: var(--green); background: rgba(16, 185, 129, 0.1); border-color: rgba(16, 185, 129, 0.2); }
    .btn-act-stop:hover { color: var(--red); background: rgba(244, 63, 94, 0.1); border-color: rgba(244, 63, 94, 0.2); }
    .btn-act-pay { color: var(--cyan); border-color: rgba(6, 182, 212, 0.2); background: rgba(6, 182, 212, 0.05); }
    .btn-act-pay:hover { background: rgba(6, 182, 212, 0.15); box-shadow: 0 0 15px rgba(6, 182, 212, 0.2); }

    .modal-overlay { 
        display: none; 
        position: fixed; 
        top: 0; 
        left: 0; 
        width: 100%; 
        height: 100%; 
        background: rgba(0,0,0,0.8); 
        z-index: 2000; 
        align-items: center; 
        justify-content: center; 
        backdrop-filter: blur(8px); 
    }
    .modal-content { 
        background: #18181b; 
        padding: 30px; 
        border-radius: 24px; 
        width: 90%; 
        max-width: 480px; 
        border: 1px solid var(--border); 
        animation: slideUpFade 0.4s cubic-bezier(0.16, 1, 0.3, 1); 
        max-height: 90vh; 
        overflow-y: auto; 
        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
    }
    @keyframes slideUpFade { from { transform: translateY(40px) scale(0.95); opacity: 0; } to { transform: translateY(0) scale(1); opacity: 1; } }
    
    @keyframes pulse {
        0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.7); }
        70% { transform: scale(1.02); box-shadow: 0 0 0 10px rgba(16, 185, 129, 0); }
        100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(16, 185, 129, 0); }
    }

    .form-section { 
        background: rgba(255,255,255,0.02); 
        border: 1px solid var(--border); 
        border-radius: 16px; 
        padding: 25px; 
        margin-bottom: 25px; 
    }
    
    .plan-option { 
        background: rgba(255,255,255,0.03); 
        border: 1px solid var(--border); 
        padding: 20px; 
        border-radius: 12px; 
        margin-bottom: 12px; 
        display: flex; 
        justify-content: space-between; 
        align-items: center; 
        cursor: pointer; 
        transition: all 0.2s; 
    }
    .plan-option:hover { background: rgba(255,255,255,0.06); border-color: var(--primary); transform: scale(1.01); }
    .plan-title { font-weight: 700; font-size: 1.05rem; color: var(--text-main); }
    .plan-desc { font-size: 0.8rem; color: var(--text-muted); margin-top: 6px; }
    .plan-price { font-weight: 800; color: var(--green); font-size: 1.2rem; }
    .plan-badge-resell { background: var(--purple-dark); color: #e9d5ff; font-size: 0.7rem; padding: 4px 8px; border-radius: 6px; margin-left: 8px; font-weight: 600; }

    #feedback-area { 
        position: fixed; 
        top: 30px; 
        left: 50%; 
        transform: translateX(-50%); 
        z-index: 10000; 
        padding: 14px 30px; 
        border-radius: 50px; 
        font-size: 0.95rem; 
        font-weight: 600; 
        box-shadow: 0 10px 30px rgba(0,0,0,0.5); 
        display: none; 
        width: auto; 
        min-width: 300px;
        text-align: center; 
        backdrop-filter: blur(10px);
    }
    .feedback-success { background: rgba(16, 185, 129, 0.9); color: white; }
    .feedback-error { background: rgba(244, 63, 94, 0.9); color: white; }

    .section-divider-title { 
        font-size: 0.85rem; 
        color: var(--primary); 
        margin: 25px 0 15px 0; 
        border-bottom: 1px solid rgba(99, 102, 241, 0.2); 
        padding-bottom: 8px; 
        text-transform: uppercase; 
        letter-spacing: 0.05em; 
        font-weight: 700;
    }
    
    .admin-tools { margin-top: 20px; padding-top: 20px; border-top: 1px dashed #3f3f46; display: flex; align-items: center; justify-content: space-between; gap: 15px; }
    .admin-tools span { font-size: 0.8rem; color: var(--text-muted); font-weight: 600; }
    
    .counter-wrapper { display: flex; align-items: center; background: var(--bg-input); border: 1px solid var(--border); border-radius: 8px; overflow: hidden; }
    .counter-btn { background: rgba(255,255,255,0.05); border: none; color: var(--text-main); padding: 10px 14px; cursor: pointer; transition: 0.2s; }
    .counter-btn:hover { background: rgba(255,255,255,0.1); }
    .days-input { width: 60px !important; text-align: center; border: none !important; margin: 0 !important; padding: 5px !important; background: transparent !important; font-weight: bold; font-size: 1rem; }
    
    .btn-save-days { 
        background: var(--primary); 
        color: white; 
        border: none; 
        border-radius: 8px; 
        width: 40px; 
        height: 40px; 
        display: flex; 
        align-items: center; 
        justify-content: center; 
        cursor: pointer; 
        box-shadow: 0 4px 15px rgba(0,0,0,0.2); 
        transition: 0.2s;
    }
    .btn-save-days:hover { transform: scale(1.1); }

    .list-container {
        max-height: 220px; overflow-y: auto; background: var(--bg-input);
        border-radius: 12px; border: 1px solid var(--border); padding: 15px; margin-bottom: 20px;
    }
    .ignored-item {
        display: flex; justify-content: space-between; align-items: center;
        background: rgba(255,255,255,0.03); padding: 10px 15px; border-radius: 8px;
        font-size: 0.9rem; margin-bottom: 8px; font-weight: 500; border: 1px solid transparent;
    }
    .ignored-item:hover { border-color: rgba(255,255,255,0.1); background: rgba(255,255,255,0.05); }
    .ignored-item .fas.fa-times { color: var(--text-muted); cursor: pointer; padding: 6px; transition: 0.2s; }
    .ignored-item .fas.fa-times:hover { color: var(--red); transform: scale(1.2); }

    .payment-success-container {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        width: 100%;
        text-align: center;
        padding: 20px 0;
    }

    .qr-wrapper {
        background: #fff;
        padding: 20px; 
        border-radius: 16px;
        margin: 20px auto;
        display: flex;
        justify-content: center;
        align-items: center;
        box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        width: fit-content;
        border: 4px solid white;
    }

    .amount-display {
        font-size: 2.5rem;
        color: var(--text-main);
        font-weight: 800;
        margin: 15px 0 10px 0;
        letter-spacing: -1px;
        text-shadow: 0 0 20px rgba(255,255,255,0.1);
    }

    .copy-row {
        display: flex;
        gap: 12px;
        margin-top: 20px;
        width: 100%;
        justify-content: center;
    }

    .input-copy {
        background: rgba(255,255,255,0.05);
        border: 1px solid var(--border);
        color: var(--text-muted);
        padding: 12px;
        border-radius: 10px;
        font-size: 0.85rem;
        text-align: center;
        width: 100%;
        margin: 0 !important;
        font-family: 'Courier New', monospace;
    }

    .btn-copy {
        background: var(--primary); 
        color: white;
        border: none;
        border-radius: 10px;
        padding: 0 24px;
        font-weight: bold;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: 0.2s;
    }
    .btn-copy:hover { filter: brightness(1.1); }

    .btn-share-pix {
        background: #fff;
        color: #000;
        border: none;
        width: 100%;
        padding: 14px;
        border-radius: 10px;
        margin-top: 15px;
        font-weight: 700;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
        transition: transform 0.2s;
    }
    .btn-share-pix:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(255,255,255,0.2); }

    .btn-support {
        position: fixed;
        bottom: 30px;
        right: 30px;
        width: 64px;
        height: 64px;
        background: linear-gradient(135deg, #25D366 0%, #128C7E 100%);
        color: #fff;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 2.2rem;
        box-shadow: 0 10px 25px rgba(37, 211, 102, 0.4);
        z-index: 10001;
        transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        text-decoration: none; 
    }
    .btn-support:hover { transform: scale(1.1) rotate(10deg); }
    .btn-support:active { transform: scale(0.9); }
    
    .checkbox-group {
        display: flex;
        align-items: center;
        gap: 12px;
        background: rgba(255,255,255,0.03);
        padding: 16px;
        border-radius: 12px;
        border: 1px solid var(--border);
        margin-top: 20px;
        transition: 0.2s;
    }
    .checkbox-group:hover { border-color: var(--primary); background: rgba(255,255,255,0.05); }
    .checkbox-group input { width: 20px; height: 20px; accent-color: var(--primary); cursor: pointer; }
    .checkbox-group label { margin: 0; font-weight: 600; font-size: 0.95rem; cursor: pointer; }
    
    .bot-tag {
        font-size: 0.7rem;
        font-weight: 700;
        background: var(--purple-dark);
        color: #e9d5ff;
        padding: 4px 10px;
        border-radius: 20px;
        margin-left: 10px;
        letter-spacing: 0.03em;
    }
    .platform-icon-wa { color: var(--whatsapp-green); filter: drop-shadow(0 0 5px rgba(37, 211, 102, 0.3)); }
    .platform-icon-tg { color: var(--telegram-blue); filter: drop-shadow(0 0 5px rgba(34, 158, 217, 0.3)); }

    .bot-groups-container {
        margin-top: 20px;
        border-top: 1px solid var(--border);
        padding-top: 20px;
        display: none;
    }
    .bot-groups-container.show { display: block; animation: slideDown 0.4s ease; }
    @keyframes slideDown { from { opacity: 0; transform: translateY(-15px); } to { opacity: 1; transform: translateY(0); } }

    .groups-toggle-btn {
        background: rgba(255,255,255,0.03);
        color: var(--text-main);
        border: 1px solid var(--border);
        width: 100%;
        padding: 14px;
        border-radius: 10px;
        margin-top: 15px;
        cursor: pointer;
        font-size: 0.9rem;
        font-weight: 600;
        display: flex;
        justify-content: space-between;
        align-items: center;
        transition: 0.2s;
    }
    .groups-toggle-btn:hover { background: rgba(255,255,255,0.08); border-color: var(--text-muted); }

    .nested-group-card {
        background: rgba(0, 0, 0, 0.2);
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 18px;
        position: relative;
    }
    .nested-group-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
    .nested-group-title { font-weight: 700; font-size: 1.1rem; color: var(--text-main); display: flex; align-items: center; gap: 10px; }
    .nested-group-actions { display: flex; gap: 12px; margin-top: 18px; flex-wrap: wrap; }
    
    .btn-nested-action {
        flex: 1;
        padding: 12px;
        font-size: 0.9rem;
        border-radius: 8px;
        border: none;
        cursor: pointer;
        font-weight: 600;
        display: flex; align-items: center; justify-content: center; gap: 8px;
        min-width: 100px;
        transition: 0.2s;
    }
    .btn-nested-action:hover { transform: translateY(-2px); filter: brightness(1.1); }

    .empty-state {
        text-align: center;
        padding: 60px 20px;
        color: var(--text-muted);
        border: 2px dashed var(--border);
        border-radius: 24px;
        margin-top: 30px;
        background: rgba(255,255,255,0.01);
    }
    .empty-state i { font-size: 3.5rem; margin-bottom: 20px; color: var(--primary); opacity: 0.4; }
    .empty-state h3 { color: var(--text-main); margin: 0 0 12px 0; font-size: 1.2rem; }
    .empty-state p { font-size: 0.95rem; margin: 0; max-width: 400px; margin: 0 auto; }

    .type-select-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 15px;
        margin-top: 20px;
    }
    .type-card {
        background: rgba(255,255,255,0.03);
        border: 1px solid var(--border);
        border-radius: 16px;
        padding: 25px 15px;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 10px;
    }
    .type-card:hover {
        background: rgba(255,255,255,0.06);
        border-color: var(--primary);
        transform: translateY(-3px);
    }
    .type-card i {
        font-size: 2rem;
        color: var(--primary);
        margin-bottom: 5px;
    }
    .type-card h4 {
        margin: 0;
        font-size: 1rem;
        color: var(--text-main);
    }
    .type-card p {
        margin: 0;
        font-size: 0.8rem;
        color: var(--text-muted);
    }
</style>
</head>
<body>

    <div id="pwa-update-bar">
        <span>Nova versão disponível!</span>
        <button id="pwa-update-btn">ATUALIZAR AGORA</button>
    </div>

    <div id="feedback-area"></div>

    <div id="sidebar-overlay" class="sidebar-overlay" onclick="toggleSidebar()"></div>
    <div id="sidebar" class="sidebar">
        <div class="sidebar-header">
            <span class="sidebar-title"><i class="fas fa-bars"></i> Menu</span>
            <i class="fas fa-times" onclick="toggleSidebar()" style="cursor:pointer; padding:5px;"></i>
        </div>
        <div class="sidebar-content">
            <button class="sidebar-btn active" id="btn-nav-dashboard" onclick="navToDashboard()">
                <i class="fas fa-home"></i> Início
            </button>
            <button class="sidebar-btn" id="btn-nav-admin" onclick="navToAdminSettings()">
                <i class="fas fa-cog"></i> Administração
            </button>
        </div>
    </div>

    <div id="auth-section" class="auth-wrapper">
        <div class="auth-card">
            <div style="text-align: center; margin-bottom: 30px;">
                <h1 style="color: var(--primary); margin: 0; font-size: 2rem;"><i class="fas fa-robot"></i></h1>
                <h2 style="margin: 5px 0 0 0; font-size: 1.5rem;">ZappBot</h2>
                <p style="color: var(--text-muted); font-size: 0.9rem;">Automação Simplificada</p>
            </div>
            
            <div id="login-form-container">
                <form id="login-form">
                    <div class="input-group" style="margin-bottom:15px;"><label class="input-label">Seu Email ou Usuário</label><input type="text" id="login-username" required></div>
                    <div class="input-group" style="margin-bottom:20px;"><label class="input-label">Sua Senha</label><input type="password" id="login-password" required></div>
                    <button type="submit" id="btn-login-submit" class="btn-primary">Entrar no Painel</button>
                </form>
                <div class="auth-divider"><span>ou continue com</span></div>
                <a href="/auth/google" class="btn-google"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48"><path fill="#FFC107" d="M43.611,20.083H42V20H24v8h11.303c-1.649,4.657-6.08,8-11.303,8c-6.627,0-12-5.373-12-12c0-6.627,5.373-12,12-12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C12.955,4,4,12.955,4,24c0,11.045,8.955,20,20,20c11.045,0,20-8.955,20-20C44,22.659,43.862,21.35,43.611,20.083z"/><path fill="#FF3D00" d="M6.306,14.691l6.571,4.819C14.655,15.108,18.961,12,24,12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C16.318,4,9.656,8.337,6.306,14.691z"/><path fill="#4CAF50" d="M24,44c5.166,0,9.86-1.977,13.409-5.192l-6.19-5.238C29.211,35.091,26.715,36,24,36c-5.202,0-9.619-3.317-11.283-7.946l-6.522,5.025C9.505,39.556,16.227,44,24,44z"/><path fill="#1976D2" d="M43.611,20.083H42V20H24v8h11.303c-0.792,2.237-2.231,4.166-4.087,5.571c0.001-0.001,0.002-0.001,0.003-0.002l6.19,5.238C36.971,39.205,44,34,44,24C44,22.659,43.862,21.35,43.611,20.083z"/></svg> Google</a>
                <p class="text-center" style="margin-top: 20px; font-size: 0.9rem;">
                    Não tem conta? <a href="#" style="color: var(--primary); text-decoration: none; font-weight: 600;" onclick="toggleAuthForms()">Criar conta</a>
                </p>
            </div>

            <div id="register-form-container" class="hidden">
                <form id="register-form">
                    <div class="input-group" style="margin-bottom:15px;">
                        <label class="input-label">Escolha um Usuário</label>
                        <input type="text" id="reg-username" required>
                    </div>
                    <div class="input-group" style="margin-bottom:20px;">
                        <label class="input-label">Escolha uma Senha</label>
                        <input type="password" id="reg-password" required>
                    </div>
                    <button type="submit" id="btn-register-submit" class="btn-primary">Criar Conta</button>
                </form>
                <p class="text-center" style="margin-top: 20px; font-size: 0.9rem;">
                    Já tem conta? <a href="#" style="color: var(--primary); text-decoration: none; font-weight: 600;" onclick="toggleAuthForms()">Fazer Login</a>
                </p>
            </div>
        </div>
    </div>

    <div id="dashboard-container" class="hidden">
        <header>
            <div class="nav-bar">
                <div style="display:flex; align-items:center; gap:10px;">
                    <button id="nav-back-btn" class="nav-btn hidden" onclick="goBackToAdminHome()"><i class="fas fa-chevron-left"></i></button>
                    <button id="admin-menu-btn" class="nav-btn hidden" onclick="toggleSidebar()"><i class="fas fa-bars"></i></button>
                </div>
                
                <div class="brand-center"><i class="fas fa-robot"></i> ZappBot</div>
                <a href="#" class="nav-btn logout" title="Sair" onclick="confirmLogout()"><i class="fas fa-sign-out-alt"></i></a>
            </div>
            <div class="user-strip">
                <i class="fas fa-user-circle"></i> Olá, <strong id="user-display-name" class="text-truncate">...</strong>
                <div id="user-limit-badge" class="limit-badge" onclick="openResellModal()" title="Clique para aumentar seu limite">Limite: <span id="current-limit-display">1</span> <i class="fas fa-plus-circle" style="font-size:0.6rem;"></i></div>
            </div>
        </header>
        <div class="container">
            
            <div id="user-view">
                <div id="view-header" style="margin: 15px 0; display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <h2 id="main-title-text" style="font-size: 1.2rem; margin: 0;">Meus Robôs</h2>
                        <p id="sub-title-text" style="color: var(--text-muted); font-size: 0.85rem; margin-top: 5px;">Aqui você cria e controla seus atendentes virtuais.</p>
                    </div>
                    <button class="btn-primary" onclick="openCreateModal()" style="width: auto; padding: 10px 20px; font-size: 0.9rem;">
                        <i class="fas fa-plus"></i> Novo Robô
                    </button>
                </div>
                
                <div id="bots-grid"></div>

                <div id="user-logs-area" class="hidden" style="margin-top: 30px;">
                    <h4>Histórico de Atividades</h4>
                    <div id="user-log-content" class="logs-container" style="height: 150px; color: #ccc;"></div>
                </div>
            </div>

            <div id="admin-settings-view" class="hidden">
                <div id="view-header-admin" style="margin: 15px 0;">
                    <h2 style="font-size: 1.2rem; margin: 0;">Administração</h2>
                    <p style="color: var(--text-muted); font-size: 0.85rem; margin-top: 5px;">Configurações globais e gerenciamento de usuários.</p>
                </div>

                <div class="form-section" style="border-color: var(--yellow);">
                    <h4 style="color: var(--yellow); margin-top: 0; margin-bottom: 15px;"><i class="fas fa-database"></i> Backup e Restauração</h4>
                    <p class="help-text">Baixe um backup completo dos dados (Usuários, Bots, Grupos e Configurações) para segurança. As sessões do WhatsApp (QR Codes) não são incluídas para manter o arquivo leve.</p>
                    
                    <div style="display: flex; gap: 15px; flex-wrap: wrap;">
                        <button onclick="downloadBackup()" class="btn-primary" style="background: var(--bg-input); border: 1px solid var(--yellow); color: var(--yellow); flex: 1;">
                            <i class="fas fa-download"></i> Baixar Backup (JSON)
                        </button>
                        
                        <div style="flex: 1; display: flex; gap: 10px;">
                            <input type="file" id="restore-file-input" accept=".zip" style="display: none;" onchange="handleRestoreFile()">
                            <button onclick="document.getElementById('restore-file-input').click()" class="btn-primary" style="background: var(--yellow); color: #000;">
                                <i class="fas fa-upload"></i> Restaurar Backup
                            </button>
                        </div>
                    </div>
                </div>

                <div class="form-section" style="border-color: var(--cyan);">
                    <h4 style="color: var(--cyan); margin-top: 0; margin-bottom: 15px;"><i class="fas fa-cog"></i> Preços e Configurações</h4>
                    <form id="admin-settings-form">
                        <div class="input-group"><label class="input-label">Token MercadoPago (Produção)</label><input type="text" id="mp-access-token" placeholder="APP_USR-xxxxxxxx..." required></div>
                        <div class="section-divider-title">Preços Renovação (Individual & Grupos)</div>
                        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px;">
                            <div><label style="font-size:0.75rem; color:#888;">Mensal (R$)</label><input type="number" id="price-monthly" step="0.01"></div>
                            <div><label style="font-size:0.75rem; color:#888;">Trimestral (R$)</label><input type="number" id="price-quarterly" step="0.01"></div>
                            <div><label style="font-size:0.75rem; color:#888;">Semestral (R$)</label><input type="number" id="price-semiannual" step="0.01"></div>
                            <div><label style="font-size:0.75rem; color:#888;">Anual (R$)</label><input type="number" id="price-yearly" step="0.01"></div>
                        </div>
                        <div class="section-divider-title">Planos Revenda (Aumento de Limite)</div>
                        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px;">
                            <div><label style="font-size:0.75rem; color:#888;">Lote 5 Bots</label><input type="number" id="price-resell-5" step="0.01"></div>
                            <div><label style="font-size:0.75rem; color:#888;">Lote 10 Bots</label><input type="number" id="price-resell-10" step="0.01"></div>
                            <div><label style="font-size:0.75rem; color:#888;">Lote 20 Bots</label><input type="number" id="price-resell-20" step="0.01"></div>
                            <div><label style="font-size:0.75rem; color:#888;">Lote 30 Bots</label><input type="number" id="price-resell-30" step="0.01"></div>
                        </div>
                        <button type="submit" class="btn-primary" style="background: var(--cyan); color: #000; margin-top: 10px;">Salvar Alterações</button>
                    </form>
                </div>

                <div class="form-section">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h4 style="margin: 0;">Gerenciar Usuários</h4>
                    </div>
                    <ul id="users-list" style="list-style: none; padding: 0;"></ul>
                </div>
            </div>

        </div>
    </div>

    <div id="create-bot-modal" class="modal-overlay">
        <div class="modal-content">
            <div style="display:flex; justify-content:space-between; margin-bottom:15px;">
                <h3 style="margin:0;"><i class="fas fa-plus-circle" style="color: var(--primary);"></i> Criar Novo Robô</h3>
                <i class="fas fa-times" onclick="closeCreateModal()" style="padding:10px; cursor:pointer;"></i>
            </div>

            <div id="create-step-1">
                <p style="color: var(--text-muted); font-size: 0.9rem; text-align: center;">Qual será a função deste robô?</p>
                <div class="type-select-grid">
                    <div class="type-card" onclick="selectBotType('individual')">
                        <i class="fas fa-user-shield"></i>
                        <h4>Atendimento Privado</h4>
                        <p>Responde clientes no PV (1 a 1).</p>
                    </div>
                    <div class="type-card" onclick="selectBotType('group')">
                        <i class="fas fa-users"></i>
                        <h4>Gestão de Grupos</h4>
                        <p>Administra e responde em grupos.</p>
                    </div>
                </div>
            </div>

            <div id="create-step-2" class="hidden">
                <form id="add-bot-form">
                    <input type="hidden" id="selectedBotType" value="individual">
                    
                    <div class="input-group">
                        <label for="botPlatform" class="input-label">Plataforma</label>
                        <select id="botPlatform" onchange="togglePlatformFields()">
                            <option value="whatsapp">WhatsApp</option>
                            <option value="telegram">Telegram</option>
                        </select>
                    </div>

                    <div id="telegram-token-group" class="input-group hidden" style="display: none;">
                        <label for="telegramToken" class="input-label">Token do Bot (Telegram)</label>
                        <span class="help-text">Cole o token fornecido pelo @BotFather.</span>
                        <input type="text" id="telegramToken" placeholder="Ex: 123456:ABC-DEF1234ghIkl-zyx57W2v1u123ew11">
                    </div>

                    <div class="input-group">
                        <label for="sessionName" class="input-label">1. Nome de Identificação</label>
                        <span class="help-text">Um nome curto para você identificar este bot (ex: Loja_Centro). Sem espaços.</span>
                        <input type="text" id="sessionName" required placeholder="Ex: Bot_Vendas_01">
                    </div>
                    
                    <div id="prompt-container" class="input-group">
                        <label for="prompt" class="input-label">2. Personalidade do Robô <span class="example-link" onclick="fillExamplePrompt()">Ver Exemplo</span></label>
                        <span class="help-text">Explique como ele deve agir. Diga quem ele é, o que vende e como deve responder.</span>
                        <textarea id="prompt" rows="6" required placeholder="Ex: Você é um assistente virtual da Loja X..."></textarea>
                    </div>
                    
                    <div style="display: flex; gap: 10px; margin-top: 20px;">
                        <button type="button" class="btn-primary" onclick="backToBotTypeSelect()" style="background: transparent; border: 1px solid var(--border); color: var(--text-muted); width: auto;">
                            <i class="fas fa-arrow-left"></i>
                        </button>
                        <button type="submit" class="btn-primary" id="create-bot-btn" style="flex: 1;">Salvar e Criar Robô</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div id="edit-modal" class="modal-overlay">
        <div class="modal-content">
            <div style="display:flex; justify-content:space-between; margin-bottom:15px;"><h3>Editar Robô</h3><i class="fas fa-times" onclick="closeEditModal()" style="padding:10px; cursor:pointer;"></i></div>
            <form id="edit-bot-form">
                <input type="hidden" id="edit-sessionName-hidden">
                <label class="input-label">Nome de Identificação</label>
                <input type="text" id="edit-sessionName-display" disabled style="opacity: 0.5; margin-bottom:15px; width:100%; padding:10px; border:1px solid #333; background:#111; color:#777; border-radius:6px;">
                
                <div id="edit-global-settings">
                    <label class="input-label">Personalidade</label>
                    <textarea id="edit-prompt" rows="8" required style="font-family: sans-serif;"></textarea>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 15px;">
                        <div>
                            <label class="input-label">Nome do Bot</label>
                            <input type="text" id="edit-botName" placeholder="Ex: Alfred">
                        </div>
                        <div>
                            <label class="input-label">Silêncio (min)</label>
                            <input type="number" id="edit-silenceTime" placeholder="0" min="0">
                        </div>
                    </div>
                </div>
                
                <div id="edit-group-mode-msg" class="hidden" style="background: rgba(255,255,255,0.05); padding: 15px; border-radius: 8px; margin-bottom: 15px; text-align: center; color: var(--text-muted); font-size: 0.9rem;">
                    <i class="fas fa-info-circle"></i> Este bot está em Modo Grupo. As configurações de Personalidade, Nome e Silêncio devem ser feitas individualmente em cada grupo.
                </div>

                <div class="checkbox-group">
                    <input type="checkbox" id="edit-botTypeGroup">
                    <div>
                        <label for="edit-botTypeGroup">Ativar Modo Grupo</label>
                        <div class="help-text">Este bot atuará em múltiplos grupos.</div>
                    </div>
                </div>
                <button type="submit" class="btn-primary" style="margin-top:10px;">Salvar Alterações</button>
            </form>
        </div>
    </div>

    <div id="group-edit-modal" class="modal-overlay">
        <div class="modal-content">
            <div style="display:flex; justify-content:space-between; margin-bottom:15px;"><h3>Configurar Grupo</h3><i class="fas fa-times" onclick="document.getElementById('group-edit-modal').style.display='none'" style="padding:10px; cursor:pointer;"></i></div>
            <form id="edit-group-form">
                <input type="hidden" id="edit-group-id-hidden">
                <p style="margin-bottom: 15px; color: var(--text-muted); font-size: 0.9rem;">Grupo: <strong id="edit-group-name-display" style="color: var(--text-main);"></strong></p>
                
                <label class="input-label">Personalidade (Prompt)</label>
                <span class="help-text">Como o bot deve se comportar neste grupo específico.</span>
                <textarea id="edit-group-prompt" rows="6" style="font-family: sans-serif;" placeholder="Ex: Você é o admin deste grupo..."></textarea>
                
                <div style="margin-top: 15px;">
                    <label class="input-label">Nome do Bot (Gatilho)</label>
                    <span class="help-text">Nome para chamar o bot neste grupo.</span>
                    <input type="text" id="edit-group-botname" placeholder="Ex: Jarvis">
                </div>

                <div style="margin-top: 15px;">
                    <label class="input-label">Tempo de Silêncio (min)</label>
                    <span class="help-text">Intervalo entre respostas automáticas neste grupo.</span>
                    <input type="number" id="edit-group-silence" placeholder="0" min="0">
                </div>

                <button type="submit" class="btn-primary" style="margin-top:20px;">Salvar Configurações</button>
            </form>
        </div>
    </div>

    <div id="ignore-modal" class="modal-overlay">
        <div class="modal-content">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                <h3 style="margin-top:0;">Ignorar por Nome</h3>
                <i class="fas fa-times" onclick="document.getElementById('ignore-modal').style.display='none'" style="padding:10px; cursor:pointer;"></i>
            </div>
            <p class="help-text" style="margin-top:-10px; margin-bottom:15px;">O robô não responderá aos contatos com nome exato na lista. O bot será reiniciado a cada alteração.</p>
            
            <input type="hidden" id="ignore-sessionName-hidden">
            
            <form id="add-identifier-form">
                <div style="display:flex; gap:10px;">
                    <input type="text" id="new-identifier-input" required placeholder="Digite o nome completo do contato">
                    <button type="submit" class="btn-primary" style="width:auto; padding:0 20px;">Adicionar</button>
                </div>
            </form>

            <div class="section-divider-title" style="margin-top: 30px;">Atualmente Ignorados</div>
            <div id="ignored-list-container" class="list-container">
            </div>
        </div>
    </div>

    <div id="pairing-modal" class="modal-overlay">
        <div class="modal-content">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                <h3 style="margin-top:0;">Conectar com Número</h3>
                <i class="fas fa-times" onclick="document.getElementById('pairing-modal').style.display='none'" style="padding:10px; cursor:pointer;"></i>
            </div>
            <p class="help-text" style="margin-top:-10px; margin-bottom:15px;">Digite o número do WhatsApp que será o robô (com DDD). Ex: 5511999999999</p>
            
            <input type="hidden" id="pairing-sessionName-hidden">
            
            <form id="pairing-form">
                <div class="input-group">
                    <input type="number" id="pairing-phone-number" required placeholder="5511999999999" style="text-align:center; font-size:1.2rem; letter-spacing:1px;">
                </div>
                <button type="submit" class="btn-primary">Gerar Código</button>
            </form>
        </div>
    </div>

    <div id="payment-modal" class="modal-overlay">
        <div class="modal-content text-center">
            <i class="fas fa-times" onclick="closePaymentModal()" style="position:absolute; right:20px; top:20px; padding:10px; cursor:pointer;"></i>
            <h3 style="color: var(--cyan);">Renovar Acesso</h3>
            <p style="font-size: 0.9rem; color: #aaa; margin-bottom: 20px;">
                <span id="payment-target-label">Robô</span>: <strong id="pay-session-name" style="color: white;"></strong>
            </p>
            
            <div id="pay-step-select">
                <p style="color:#e1e1e6; margin-bottom:15px; font-weight:600;">Por quanto tempo deseja renovar?</p>
                <div id="plans-container"></div>
            </div>

            <div id="pix-loading" class="hidden payment-success-container" style="padding: 40px 0;">
                <i class="fas fa-circle-notch fa-spin fa-2x" style="color: var(--cyan);"></i>
                <p style="margin-top: 15px;">Gerando código Pix...</p>
            </div>

            <div id="pix-content" class="hidden payment-success-container">
                <h2 id="pay-amount" class="amount-display">R$ --</h2>
                
                <div class="qr-wrapper">
                    <img id="pix-qrcode-display" src="" style="width: 180px; display: block;">
                </div>

                <div class="copy-row">
                    <input type="text" id="pix-copy-paste" readonly class="input-copy">
                    <button onclick="copyPixCode('pix-copy-paste')" class="btn-copy" style="background: var(--cyan);">Copiar</button>
                </div>

                <button onclick="sharePixPayment('individual')" class="btn-share-pix">
                    <i class="fas fa-share-alt"></i> Compartilhar Pagamento
                </button>

                <p style="color: var(--green); font-size: 0.8rem; margin-top: 15px;"><i class="fas fa-check-circle"></i> Liberação Automática após pagamento</p>
                <button onclick="resetPaymentModal()" style="background:transparent; color:#888; border:1px solid #333; padding:8px 20px; border-radius:20px; margin-top:10px; font-size:0.8rem;">Voltar</button>
            </div>
        </div>
    </div>

    <div id="resell-modal" class="modal-overlay">
        <div class="modal-content text-center">
            <i class="fas fa-times" onclick="document.getElementById('resell-modal').style.display='none'" style="position:absolute; right:20px; top:20px; padding:10px; cursor:pointer;"></i>
            <h3 style="color: var(--primary);">Aumente seu Limite!</h3>
            <p style="font-size: 0.9rem; color: #aaa; margin-bottom: 20px;">Limite atual: <strong><span id="current-limit-display-modal">1</span></strong> robô(s).</p>
            
            <div id="resell-step-select">
                <div id="resell-plans-container"></div>
            </div>
            
            <div id="resell-pix-loading" class="hidden payment-success-container" style="padding: 40px 0;">
                <i class="fas fa-circle-notch fa-spin fa-2x" style="color: var(--primary);"></i>
                <p style="margin-top: 10px;">Gerando Pix...</p>
            </div>

            <div id="resell-pix-content" class="hidden payment-success-container">
                <h2 id="resell-pay-amount" class="amount-display">R$ --</h2>
                
                <div class="qr-wrapper">
                    <img id="resell-qrcode-display" src="" style="width: 180px; display: block;">
                </div>

                <div class="copy-row">
                    <input type="text" id="resell-copy-paste" readonly class="input-copy">
                    <button onclick="copyPixCode('resell-copy-paste')" class="btn-copy">Copiar</button>
                </div>

                <button onclick="sharePixPayment('resell')" class="btn-share-pix">
                    <i class="fas fa-share-alt"></i> Compartilhar Pagamento
                </button>

                <p style="color: var(--green); font-size: 0.8rem; margin-top: 15px;">Limite atualizado automaticamente!</p>
            </div>
        </div>
    </div>

    <div id="activation-link-modal" class="modal-overlay">
        <div class="modal-content">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                <h3 style="margin:0; color: var(--blue);">Link de Ativação de Grupo</h3>
                <i class="fas fa-times" onclick="document.getElementById('activation-link-modal').style.display='none'" style="padding:10px; cursor:pointer;"></i>
            </div>
            <p class="help-text" style="margin-bottom: 20px;">Siga os passos abaixo para ativar seu grupo:</p>
            <ol style="font-size: 0.9rem; line-height: 1.7; padding-left: 20px; color: var(--text-muted);">
                <li style="margin-bottom: 10px;">Adicione o bot ('<strong id="modal-bot-name"></strong>') ao grupo.</li>
                <li style="margin-bottom: 10px;">Clique no botão abaixo para copiar o link de ativação único.</li>
                <li style="margin-bottom: 10px;">Cole e envie este link como uma mensagem dentro do grupo que você deseja ativar.</li>
                <li style="margin-bottom: 10px; color: var(--green); font-weight: bold;">Após ativar, o grupo aparecerá dentro do card deste robô.</li>
            </ol>
            <div class="input-group" style="margin-top: 25px;">
                <label class="input-label">Seu Link Único (expira em 15 min)</label>
                <div style="display: flex; gap: 10px;">
                    <input type="text" id="activation-link-input" readonly style="background: var(--bg-input); opacity: 0.7;">
                    <button id="copy-activation-link-btn" class="btn-primary" style="width: auto; padding: 0 20px; background: var(--blue);">Copiar</button>
                </div>
            </div>
        </div>
    </div>

    <a href="https://wa.me/5524999842338" target="_blank" class="btn-support" title="Falar com Suporte">
        <i class="fab fa-whatsapp"></i>
    </a>

    <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
    <script>
        let socket;
        let currentUser = {}; 
        let botsData = {}; 
        let groupsData = {}; 
        let viewedUser = null;
        let publicPrices = {};

        document.addEventListener('DOMContentLoaded', async () => {
            
            if ('serviceWorker' in navigator) {
                const updateBar = document.getElementById('pwa-update-bar');
                const updateBtn = document.getElementById('pwa-update-btn');
                let newWorker;

                navigator.serviceWorker.register('/sw.js').then(reg => {
                    reg.addEventListener('updatefound', () => {
                        newWorker = reg.installing;
                        newWorker.addEventListener('statechange', () => {
                            if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                updateBar.classList.add('show');
                            }
                        });
                    });
                });

                updateBtn.addEventListener('click', () => {
                    newWorker.postMessage({ type: 'SKIP_WAITING' });
                });

                let refreshing;
                navigator.serviceWorker.addEventListener('controllerchange', () => {
                    if (refreshing) return;
                    window.location.reload();
                    refreshing = true;
                });
            }

            const urlParams = new URLSearchParams(window.location.search);
            if(urlParams.has('error')) {
                const errorMsg = urlParams.get('error');
                if(errorMsg && errorMsg.trim() !== "" && errorMsg.toLowerCase() !== 'bad request') {
                    showFeedback(false, errorMsg);
                }
                window.history.replaceState({}, document.title, "/");
            }

            try {
                const response = await fetch('/check-session');
                const data = await response.json();
                if (response.ok && data.loggedIn) {
                    enterDashboard(data.user);
                }
            } catch (e) { console.log("Sessão expirada ou não logado."); }
        });

        function enterDashboard(user) {
            document.getElementById('auth-section').style.display = 'none';
            document.getElementById('dashboard-container').classList.remove('hidden');
            document.getElementById('user-display-name').textContent = user.username;
            
            if (user.isAdmin) {
                document.getElementById('admin-menu-btn').classList.remove('hidden');
            } else {
                document.getElementById('admin-menu-btn').classList.add('hidden');
            }

            initializeSocket();
        }

        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebar-overlay');
            if (sidebar.classList.contains('open')) {
                sidebar.classList.remove('open');
                overlay.style.display = 'none';
            } else {
                sidebar.classList.add('open');
                overlay.style.display = 'block';
            }
        }

        function navToDashboard() {
            document.getElementById('user-view').classList.remove('hidden');
            document.getElementById('admin-settings-view').classList.add('hidden');
            
            document.getElementById('btn-nav-dashboard').classList.add('active');
            document.getElementById('btn-nav-admin').classList.remove('active');
            
            toggleSidebar();
        }

        function navToAdminSettings() {
            document.getElementById('user-view').classList.add('hidden');
            document.getElementById('admin-settings-view').classList.remove('hidden');
            
            document.getElementById('btn-nav-dashboard').classList.remove('active');
            document.getElementById('btn-nav-admin').classList.add('active');
            
            toggleSidebar();
        }

        function toggleAuthForms() {
            const login = document.getElementById('login-form-container');
            const register = document.getElementById('register-form-container');
            if(login.classList.contains('hidden')) {
                login.classList.remove('hidden'); register.classList.add('hidden');
            } else {
                login.classList.add('hidden'); register.classList.remove('hidden');
            }
        }

        async function handleAuth(url, body, btnId) {
            const btn = document.getElementById(btnId);
            const originalText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processando...';

            try {
                const res = await fetch(url, { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify(body)});
                const data = await res.json();
                
                if (res.ok) {
                    if (url === '/login') {
                        window.location.reload();
                    } else { 
                        toggleAuthForms(); 
                        document.getElementById('login-username').value = body.username; 
                        showFeedback(true, 'Conta criada! Agora faça login.'); 
                    }
                } else {
                    showFeedback(false, data.message || 'Ocorreu um erro.');
                }
            } catch (error) { 
                showFeedback(false, 'Erro de conexão com o servidor.'); 
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        }

        document.getElementById('login-form').onsubmit = (e) => { 
            e.preventDefault(); 
            handleAuth('/login', { 
                username: document.getElementById('login-username').value, 
                password: document.getElementById('login-password').value 
            }, 'btn-login-submit'); 
        };

        document.getElementById('register-form').onsubmit = (e) => {
            e.preventDefault();
            handleAuth('/register', {
                username: document.getElementById('reg-username').value,
                password: document.getElementById('reg-password').value
            }, 'btn-register-submit');
        };

        function showFeedback(success, msg) {
            const feedbackArea = document.getElementById('feedback-area');
            feedbackArea.textContent = msg;
            feedbackArea.className = success ? 'feedback-success' : 'feedback-error';
            feedbackArea.style.display = 'block';
            setTimeout(() => feedbackArea.style.display = 'none', 4000);
        }

        function fillExamplePrompt() {
            const example = "Você é o assistente virtual da Pizzaria. \n1. Seja educado.\n2. Cardápio: Pizza Queijo (R$30), Pizza Frango (R$35).";
            document.getElementById('prompt').value = example;
        }

        function confirmLogout() {
            if (confirm('Tem certeza que deseja sair do painel?')) {
                window.location.href = '/logout';
            }
        }

        function togglePlatformFields() {
            const platform = document.getElementById('botPlatform').value;
            const tokenGroup = document.getElementById('telegram-token-group');
            if (platform === 'telegram') {
                tokenGroup.classList.remove('hidden');
                tokenGroup.style.display = 'block';
            } else {
                tokenGroup.classList.add('hidden');
                tokenGroup.style.display = 'none';
            }
        }

        function openCreateModal() {
            document.getElementById('create-step-1').classList.remove('hidden');
            document.getElementById('create-step-2').classList.add('hidden');
            document.getElementById('create-bot-modal').style.display = 'flex';
        }

        function closeCreateModal() {
            document.getElementById('create-bot-modal').style.display = 'none';
        }

        function selectBotType(type) {
            document.getElementById('selectedBotType').value = type;
            
            const promptContainer = document.getElementById('prompt-container');
            const promptInput = document.getElementById('prompt');
            
            if (type === 'group') {
                promptContainer.classList.add('hidden');
                promptInput.required = false;
            } else {
                promptContainer.classList.remove('hidden');
                promptInput.required = true;
            }

            document.getElementById('create-step-1').classList.add('hidden');
            document.getElementById('create-step-2').classList.remove('hidden');
            
            togglePlatformFields();
        }

        function backToBotTypeSelect() {
            document.getElementById('create-step-2').classList.add('hidden');
            document.getElementById('create-step-1').classList.remove('hidden');
        }

        function initializeSocket() {
            if (socket && socket.connected) return;
            socket = io();

            socket.on('session-info', (data) => {
                currentUser = data;
                updateUserLimitUI(data.botLimit || 1);

                socket.emit('get-my-bots');
                socket.emit('get-my-groups');

                if (currentUser.isAdmin) {
                    socket.emit('admin-get-users');
                    socket.emit('admin-settings');
                }
                socket.emit('get-public-prices');
            });

            socket.on('update-limit', (newLimit) => {
                currentUser.botLimit = newLimit;
                updateUserLimitUI(newLimit);
                document.getElementById('resell-modal').style.display = 'none';
                showFeedback(true, `Parabéns! Seu limite agora é de ${newLimit} robôs!`);
            });

            socket.on('initial-bots-list', (bots) => { 
                const grid = document.getElementById('bots-grid');
                grid.innerHTML = ''; 
                botsData = {}; 
                
                if (bots.length === 0) {
                    grid.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-robot"></i>
                            <h3>Nenhum robô encontrado</h3>
                            <p>Clique em "Novo Robô" para começar.</p>
                        </div>
                    `;
                } else {
                    bots.forEach(renderBotCard);
                    updateAllBotGroupCounts();
                }
            });

            socket.on('initial-groups-list', (groups) => { 
                organizeGroups(groups);
                updateAllBotGroupCounts();
            });
            
            socket.on('group-list-updated', (groups) => { 
                organizeGroups(groups);
                updateAllBotGroupCounts();
            });

            socket.on('bot-updated', (bot) => { 
                if (!currentUser.isAdmin && bot.owner !== currentUser.username) return;
                if (currentUser.isAdmin && viewedUser && bot.owner !== viewedUser) return;
                
                if (currentUser.isAdmin && !viewedUser && bot.owner === currentUser.username) {
                } else if (currentUser.isAdmin && !viewedUser && bot.owner !== currentUser.username) {
                    return; 
                }

                const btn = document.getElementById('create-bot-btn');
                if(btn.disabled && document.getElementById(`bot-${bot.sessionName}`)) {
                    btn.disabled = false;
                    btn.innerHTML = 'Salvar e Criar Robô';
                }
                
                const emptyState = document.querySelector('.empty-state');
                if (emptyState) emptyState.remove();

                renderBotCard(bot); 
                renderGroupsForBot(bot.sessionName);
            });
            socket.on('bot-deleted', (d) => { 
                const el = document.getElementById(`bot-${d.sessionName}`); 
                if(el) el.remove(); 
                
                const grid = document.getElementById('bots-grid');
                if (grid.children.length === 0) {
                    grid.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-robot"></i>
                            <h3>Nenhum robô encontrado</h3>
                            <p>Clique em "Novo Robô" para começar.</p>
                        </div>
                    `;
                }
            });
            socket.on('log-message', (d) => {
                const c = document.querySelector(`#bot-${d.sessionName} .logs-container`);
                if(c && !d.message.startsWith('QR_CODE:') && !d.message.startsWith('PAIRING_CODE:')) {
                    const l = document.createElement('div'); l.className='log-line'; l.textContent = `> ${d.message}`;
                    c.appendChild(l); c.scrollTop = c.scrollHeight;
                    sessionStorage.setItem(`log-${d.sessionName}`, c.innerHTML);
                }

                if (d.message && d.message.includes('Link de ativação detectado')) {
                    console.log('Link detectado, atualizando lista de grupos...');
                    socket.emit('get-my-groups');
                    showFeedback(true, 'Novo grupo detectado! Atualizando lista...');
                }
            });
            socket.on('admin-users-list', (users) => {
                const list = document.getElementById('users-list'); list.innerHTML = '';
                users.forEach(u => {
                    const li = document.createElement('li'); li.className = 'user-list-item';
                    li.style.borderBottom = "1px solid #333"; li.style.padding = "10px 0"; li.style.display="flex"; li.style.justifyContent="space-between";
                    li.innerHTML = `
                        <div style="display:flex; flex-direction:column;">
                            <span style="font-weight:600; font-size:0.9rem;">${u.username}</span>
                            <span style="font-size:0.75rem; color:#888;">${u.isAdmin ? 'Administrador' : `Limite: ${u.botLimit || 1} bots`} | ID: ${u.username}</span>
                        </div>
                        ${!u.isAdmin ? `<i class="fas fa-trash" style="color:var(--red); cursor:pointer; padding:5px;" onclick="delUser(event, '${u.username}')"></i>` : ''}
                    `;
                    li.onclick = (e) => { if(e.target.tagName !== 'I') openAdminUserView(u); };
                    list.appendChild(li);
                });
            });
            
            socket.on('admin-settings', (s) => { 
                document.getElementById('mp-access-token').value = s.mpAccessToken || ''; 
                document.getElementById('price-monthly').value = s.priceMonthly || '';
                document.getElementById('price-quarterly').value = s.priceQuarterly || '';
                document.getElementById('price-semiannual').value = s.priceSemiannual || '';
                document.getElementById('price-yearly').value = s.priceYearly || '';
                
                document.getElementById('price-resell-5').value = s.priceResell5 || '';
                document.getElementById('price-resell-10').value = s.priceResell10 || '';
                document.getElementById('price-resell-20').value = s.priceResell20 || '';
                document.getElementById('price-resell-30').value = s.priceResell30 || '';
            });

            socket.on('public-prices', (prices) => { 
                publicPrices = prices || {}; 

                if(document.getElementById('price-monthly')) {
                    document.getElementById('price-monthly').value = prices.priceMonthly || '';
                    document.getElementById('price-quarterly').value = prices.priceQuarterly || '';
                    document.getElementById('price-semiannual').value = prices.priceSemiannual || '';
                    document.getElementById('price-yearly').value = prices.priceYearly || '';
                    document.getElementById('price-resell-5').value = prices.priceResell5 || '';
                    document.getElementById('price-resell-10').value = prices.priceResell10 || '';
                    document.getElementById('price-resell-20').value = prices.priceResell20 || '';
                    document.getElementById('price-resell-30').value = prices.priceResell30 || '';
                }

                const payModal = document.getElementById('payment-modal');
                if(payModal && payModal.style.display !== 'none') {
                    const container = document.getElementById('plans-container');
                    if(container) {
                        container.innerHTML = '';
                        const plans = [
                            { id: 'monthly', title: 'Mensal', price: prices.priceMonthly, desc: '30 dias' },
                            { id: 'quarterly', title: 'Trimestral', price: prices.priceQuarterly, desc: '90 dias' },
                            { id: 'semiannual', title: 'Semestral', price: prices.priceSemiannual, desc: '180 dias' },
                            { id: 'yearly', title: 'Anual', price: prices.priceYearly, desc: '365 dias' }
                        ];
                        plans.forEach(p => {
                            const el = document.createElement('div'); el.className = 'plan-option';
                            el.innerHTML = `<div><div class="plan-title">${p.title}</div><div class="plan-desc">${p.desc}</div></div><div class="plan-price">R$ ${p.price}</div>`;
                            el.onclick = () => selectPlan(p.id);
                            container.appendChild(el);
                        });
                    }
                }

                const resellModal = document.getElementById('resell-modal');
                if(resellModal && resellModal.style.display !== 'none') {
                    const container = document.getElementById('resell-plans-container');
                    if(container) {
                        container.innerHTML = '';
                        const resellPlans = [
                            { id: 'resell_5', title: 'Pacote 5 Robôs', price: prices.priceResell5, limit: 5 },
                            { id: 'resell_10', title: 'Pacote 10 Robôs', price: prices.priceResell10, limit: 10 },
                            { id: 'resell_20', title: 'Pacote 20 Robôs', price: prices.priceResell20, limit: 20 },
                            { id: 'resell_30', title: 'Pacote 30 Robôs', price: prices.priceResell30, limit: 30 },
                        ];
                        resellPlans.forEach(p => {
                            const el = document.createElement('div'); el.className = 'plan-option';
                            el.innerHTML = `<div><div class="plan-title">${p.title} <span class="plan-badge-resell">Revenda</span></div><div class="plan-desc">Limite de ${p.limit} bots.</div></div><div class="plan-price">R$ ${p.price}</div>`;
                            el.onclick = () => selectResellPlan(p.id);
                            container.appendChild(el);
                        });
                    }
                }
            });

            socket.on('payment-success', (d) => { 
                if(document.getElementById('payment-modal').style.display !== 'none') {
                   if(document.getElementById('pay-session-name').innerText === d.sessionName) {
                       closePaymentModal(); showFeedback(true, 'Pagamento Recebido! Bot Renovado.');
                   }
                }
            });
            
            socket.on('group-activation-result', (data) => {
                if (data.success) {
                    const linkModal = document.getElementById('activation-link-modal');
                    if(linkModal) linkModal.style.display = 'none';

                    setTimeout(() => {
                        let found = false;
                        Object.values(groupsData).forEach(list => {
                            if (list.find(g => g.groupId === data.groupId)) found = true;
                        });

                        if (found) {
                            showFeedback(true, 'Grupo ativado! Configure agora.');
                            openGroupEdit(data.groupId);
                        }
                    }, 500);
                }
            });

            socket.on('feedback', (d) => {
                if(!d.success && d.error === 'limit_reached') {
                    openResellModal();
                    const btn = document.getElementById('create-bot-btn');
                    btn.disabled = false; btn.innerHTML = 'Salvar e Criar Robô';
                } else {
                    showFeedback(d.success, d.message);
                    if (d.success && d.message.includes('ativado') || d.message.includes('pronto')) {
                        socket.emit('get-my-groups');
                    }
                    if (!d.success) {
                        const btn = document.getElementById('create-bot-btn');
                        btn.disabled = false; btn.innerHTML = 'Salvar e Criar Robô';
                    } else {
                        closeCreateModal();
                        const btn = document.getElementById('create-bot-btn');
                        btn.disabled = false; btn.innerHTML = 'Salvar e Criar Robô';
                    }
                }
            });
        }

        function organizeGroups(groupsList) {
            groupsData = {};
            groupsList.forEach(group => {
                if (!groupsData[group.managedByBot]) {
                    groupsData[group.managedByBot] = [];
                }
                groupsData[group.managedByBot].push(group);
            });
        }

        function updateAllBotGroupCounts() {
            Object.keys(botsData).forEach(sessionName => {
                renderGroupsForBot(sessionName);
            });
        }

        function updateUserLimitUI(limit) {
            const display = limit > 900 ? "Ilimitado" : limit;
            document.getElementById('current-limit-display').innerText = display;
            if(document.getElementById('current-limit-display-modal')) {
                document.getElementById('current-limit-display-modal').innerText = display;
            }
        }

        function openAdminUserView(user) {
            viewedUser = user.username;
            document.getElementById('admin-settings-view').classList.add('hidden');
            document.getElementById('user-view').classList.remove('hidden');
            
            const backBtn = document.getElementById('nav-back-btn');
            backBtn.classList.remove('hidden');
            
            document.getElementById('main-title-text').textContent = user.username;
            document.getElementById('sub-title-text').textContent = `Gerenciando bots deste usuário`;
            document.getElementById('user-logs-area').classList.remove('hidden');
            const logC = document.getElementById('user-log-content'); logC.innerHTML = '';
            if(user.log) user.log.slice().reverse().forEach(l => logC.innerHTML += `<div class="log-line">${l}</div>`);
            document.getElementById('bots-grid').innerHTML = '';
            socket.emit('admin-get-bots-for-user', { username: user.username });
        }

        function goBackToAdminHome() {
            viewedUser = null;
            document.getElementById('user-view').classList.add('hidden');
            document.getElementById('admin-settings-view').classList.remove('hidden');
            document.getElementById('nav-back-btn').classList.add('hidden');
            document.getElementById('bots-grid').innerHTML = '';
        }

        function formatDate(isoString) {
            if (!isoString) return 'N/A';
            const date = new Date(isoString);
            if (isNaN(date)) return 'Data inválida';
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const year = date.getFullYear();
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            return `${day}/${month}/${year} ${hours}:${minutes}`;
        }

        function renderBotCard(bot) {
            const prevBot = botsData[bot.sessionName];
            const prevStatus = prevBot ? prevBot.status : null;
            botsData[bot.sessionName] = bot;
            
            let card = document.getElementById(`bot-${bot.sessionName}`);
            
            let statusClass = 'st-offline'; let icon = 'fa-power-off'; let txt = "Desligado";
            let timeText = 'Aguardando Ativação';
            let pct = 0;
            let isExpired = false;
            let daysForInput = 0;

            const isGroupBot = bot.botType === 'group';
            const isTelegram = bot.platform === 'telegram';

            const now = new Date();
            const expireDate = new Date(bot.trialExpiresAt);
            isExpired = expireDate < now;

            if(bot.status === 'Online') { statusClass='st-online'; icon='fa-check'; txt='Conectado'; }
            else if(bot.status.includes('Iniciando')) { statusClass='st-starting'; icon='fa-sync fa-spin'; txt='Iniciando...'; }
            else if(bot.status.includes('Aguardando')) { statusClass='st-waiting'; icon='fa-qrcode'; txt='Ler QR Code'; }
            else if(isExpired && !isGroupBot) { statusClass='st-expired'; icon='fa-times'; txt='Expirado'; }
            else if(!bot.activated) { statusClass = 'st-inactive'; icon='fa-hourglass-start'; txt='Aguardando QR'; }

            if (!isGroupBot) {
                const totalDuration = 31 * 24 * 60 * 60 * 1000;
                const timeLeft = expireDate - now;
                
                daysForInput = Math.ceil(timeLeft / (1000 * 60 * 60 * 24));
                if (daysForInput < 0) daysForInput = 0;
                
                if (bot.isTrial && !isExpired) {
                    pct = 100; 
                    timeText = 'Teste Grátis Ativo';
                } else {
                    const daysLeft = Math.ceil(timeLeft / (1000 * 60 * 60 * 24));
                    pct = Math.max(0, Math.min(100, (timeLeft/totalDuration)*100));
                    timeText = isExpired ? 'Plano Expirado' : `${daysLeft} dias restantes`;
                }
            }

            const adminTools = currentUser.isAdmin && !isGroupBot ? `
                <div class="admin-tools">
                    <span>DEFINIR DIAS RESTANTES:</span>
                    <div style="display:flex; gap:10px; align-items:center;">
                        <div class="counter-wrapper">
                            <button class="counter-btn" onclick="modDays('${bot.sessionName}', -1)"><i class="fas fa-minus"></i></button>
                            <input type="number" id="d-${bot.sessionName}" class="days-input" value="${daysForInput}">
                            <button class="counter-btn" onclick="modDays('${bot.sessionName}', 1)"><i class="fas fa-plus"></i></button>
                        </div>
                        <button class="btn-save-days" onclick="admSaveDays('${bot.sessionName}')" title="Salvar"><i class="fas fa-save"></i></button>
                    </div>
                </div>
            ` : '';

            let qrSection = '';
            if (bot.status === 'Aguardando QR Code' && !isTelegram) {
                if (bot.qr && bot.qr.startsWith('PAIRING_CODE:')) {
                    const code = bot.qr.replace('PAIRING_CODE:', '');
                    qrSection = `
                        <div class="qr-area">
                            <div class="qr-instructions"><strong>Conectar com Código:</strong><ol><li>No WhatsApp > Aparelhos Conectados</li><li>Conectar um aparelho</li><li>Toque em "Conectar com número de telefone"</li></ol></div>
                            <div class="pairing-code-display">${code}</div>
                            <p style="font-size:0.8rem; color:#666;">Digite este código no seu celular.</p>
                        </div>
                    `;
                } else {
                    qrSection = `
                        <div class="qr-area">
                            <div class="qr-instructions"><strong>Conectar WhatsApp:</strong><ol><li>Abra o WhatsApp e vá em <strong>Aparelhos Conectados</strong>.</li><li>Toque em <strong>Conectar um aparelho</strong>.</li><li>Aponte a câmera para o QR Code abaixo.</li></ol></div>
                            <div class="qr-tgt" id="qr-tgt-${bot.sessionName}"></div>
                            <button class="btn-share-qr" onclick="shareQrCode('${bot.sessionName}')"><i class="fas fa-share-alt"></i> Compartilhar QR</button>
                            <button class="btn-use-code" onclick="openPairingModal('${bot.sessionName}')"><i class="fas fa-mobile-alt"></i> Conectar com Número</button>
                        </div>
                    `;
                }
            }

            let toggleBtnHtml = '';
            const isRunning = bot.status === 'Online' || bot.status.includes('Iniciando') || bot.status.includes('Aguardando');

            if (isRunning) {
                toggleBtnHtml = `<button class="icon-btn btn-act-stop" onclick="sock('stop-bot','${bot.sessionName}')"><i class="fas fa-stop"></i><span>Desligar</span></button>`;
            } else {
                toggleBtnHtml = `<button class="icon-btn btn-act-start" onclick="sock('start-bot','${bot.sessionName}')"><i class="fas fa-play"></i><span>Iniciar</span></button>`;
            }

            const groupActivationButton = isGroupBot ? `
                <button class="btn-primary" style="background: var(--blue); color: white; margin-top: 15px;" onclick="openGroupActivationModal('${bot.sessionName}')">
                    <i class="fas fa-link"></i> Ativar Grupo com este Bot
                </button>
            ` : '';

            const platformIcon = isTelegram ? '<i class="fab fa-telegram platform-icon-tg"></i>' : '<i class="fab fa-whatsapp platform-icon-wa"></i>';

            let groupsSection = '';
            if (isGroupBot) {
                groupsSection = `
                    <div class="bot-groups-section">
                        <button class="groups-toggle-btn" onclick="toggleGroups('${bot.sessionName}')">
                            <span><i class="fas fa-users"></i> Ver Grupos Vinculados (<span id="count-${bot.sessionName}">0</span>)</span>
                            <i class="fas fa-chevron-down"></i>
                        </button>
                        <div id="groups-container-${bot.sessionName}" class="bot-groups-container">
                        </div>
                    </div>
                `;
            }

            const html = `
                <div class="card-header">
                    <div style="display:flex; align-items:center; gap:8px;">
                        <i class="fas ${isGroupBot ? 'fa-users' : 'fa-robot'}" style="color:var(--primary);"></i>
                        <span style="font-weight:600;">${bot.sessionName}</span>
                        ${platformIcon}
                        ${isGroupBot ? '<span class="bot-tag">MODO GRUPO</span>' : ''}
                    </div>
                    <div class="status-badge ${statusClass}"><i class="fas ${icon}"></i> ${txt}</div>
                </div>
                <div class="card-body">
                    ${!isGroupBot ? `
                    <div class="progress-container">
                        <div class="progress-info">
                            <span>Status</span><span style="color:${isExpired ? 'var(--red)' : 'var(--text-main)'}">${timeText}</span>
                        </div>
                        <div class="progress-bar-bg"><div class="progress-bar-fill" style="width:${pct}%; background:${isExpired ? 'var(--red)' : 'var(--primary)'}"></div></div>
                    </div>
                    <div style="border-top: 1px solid var(--border); margin-top: 10px; padding-top: 10px;">
                        <div class="date-info"><span>Criado em:</span><strong>${formatDate(bot.createdAt)}</strong></div>
                        <div class="date-info"><span>Vence em:</span><strong style="color: ${isExpired ? 'var(--red)' : 'var(--text-main)'}">${formatDate(bot.trialExpiresAt)}</strong></div>
                    </div>
                    ` : `<p class="help-text" style="text-align:center;">Este bot precisa ser conectado para poder gerenciar os grupos.</p>`}

                    ${qrSection}
                    <div class="logs-container">
                        <div style="display:flex; justify-content:space-between; margin-bottom:5px; color:#666;">
                            <span>TERMINAL</span> <span onclick="clearLogs('${bot.sessionName}')" style="cursor:pointer; font-size:0.65rem; text-decoration:underline;">Limpar</span>
                        </div>
                    </div>
                    <div class="action-grid" style="grid-template-columns: repeat(${isGroupBot ? 3 : 5}, 1fr);">
                        ${toggleBtnHtml}
                        <button class="icon-btn" onclick="openEdit('${bot.sessionName}')"><i class="fas fa-pen"></i><span>Editar</span></button>
                        ${!isGroupBot ? `<button class="icon-btn" onclick="openIgnoreModal('${bot.sessionName}')"><i class="fas fa-user-slash"></i><span>Ignorar</span></button>` : ''}
                        ${!isGroupBot ? `<button class="icon-btn btn-act-pay" onclick="openPay('${bot.sessionName}')"><i class="fas fa-bolt"></i><span>Renovar</span></button>` : ''}
                        <button class="icon-btn" onclick="delBot('${bot.sessionName}')"><i class="fas fa-trash"></i> <span>Excluir</span></button>
                    </div>
                    ${groupActivationButton}
                    ${groupsSection}
                    ${adminTools}
                </div>
            `;

            if(!card) {
                card = document.createElement('div'); card.className = 'bot-card'; card.id = `bot-${bot.sessionName}`;
                document.getElementById('bots-grid').prepend(card);
            }
            card.innerHTML = html;

            const svLogs = sessionStorage.getItem(`log-${bot.sessionName}`);
            const logC = card.querySelector('.logs-container');
            if(svLogs) { 
                const h = logC.firstElementChild.outerHTML; logC.innerHTML = h + svLogs.replace(/<div.*?TERMINAL.*?<\/div>/, ''); logC.scrollTop=logC.scrollHeight; 
            }
            if(bot.status === 'Aguardando QR Code' && bot.qr && !bot.qr.startsWith('PAIRING_CODE:') && !isTelegram) {
                const qt = card.querySelector(`#qr-tgt-${bot.sessionName}`); 
                if(qt) { 
                    qt.innerHTML=''; 
                    new QRCode(qt, {text:bot.qr, width:180, height:180}); 
                    if (prevStatus !== 'Aguardando QR Code') {
                        setTimeout(() => {
                            qt.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        }, 500);
                    }
                }
            }
        }

        function toggleGroups(sessionName) {
            const container = document.getElementById(`groups-container-${sessionName}`);
            if (container) {
                container.classList.toggle('show');
            }
        }

        function renderGroupsForBot(sessionName) {
            const container = document.getElementById(`groups-container-${sessionName}`);
            const countSpan = document.getElementById(`count-${sessionName}`);
            
            if (!container) return;

            const groups = groupsData[sessionName] || [];
            if (countSpan) countSpan.innerText = groups.length;

            container.innerHTML = '';

            if (groups.length === 0) {
                container.innerHTML = '<p style="text-align:center; color:#666; font-size:0.8rem; padding:10px;">Nenhum grupo vinculado.</p>';
                return;
            }

            groups.forEach(group => {
                const now = new Date();
                const expiresAt = group.expiresAt ? new Date(group.expiresAt) : null;
                const isExpired = expiresAt && expiresAt < now;
                const isPaused = group.isPaused === true;
                
                let statusColor = isExpired ? 'var(--red)' : 'var(--green)';
                let statusText = isExpired ? 'Expirado' : 'Ativo';
                if (group.status === 'pending_payment') {
                    statusColor = 'var(--yellow)';
                    statusText = 'Pendente';
                }
                if (isPaused && !isExpired) {
                    statusColor = 'var(--text-muted)';
                    statusText = 'Pausado';
                }

                let actionButton = '';
                if (isExpired || group.status === 'pending_payment') {
                    actionButton = `<button class="btn-nested-action" style="background:var(--cyan); color:#000;" onclick="openPay(null, '${group.groupId}', '${group.groupName}')"><i class="fas fa-bolt"></i> Pagar</button>`;
                } else {
                    actionButton = `<button class="btn-nested-action" style="background:rgba(255,255,255,0.1); color:#fff;" onclick="openPay(null, '${group.groupId}', '${group.groupName}')"><i class="fas fa-plus"></i> Estender</button>`;
                }

                const editButton = `<button class="btn-nested-action" style="background:rgba(255,255,255,0.1); color:#fff;" onclick="openGroupEdit('${group.groupId}')"><i class="fas fa-pen"></i> Config</button>`;
                
                let toggleButton = '';
                if (!isExpired && group.status !== 'pending_payment') {
                    if (isPaused) {
                        toggleButton = `<button class="btn-nested-action" style="background:rgba(4, 211, 97, 0.2); color:var(--green);" onclick="toggleGroupStatus('${group.groupId}', false)"><i class="fas fa-play"></i> Iniciar</button>`;
                    } else {
                        toggleButton = `<button class="btn-nested-action" style="background:rgba(247, 90, 104, 0.2); color:var(--red);" onclick="toggleGroupStatus('${group.groupId}', true)"><i class="fas fa-stop"></i> Parar</button>`;
                    }
                }

                let daysForInput = 0;
                if (expiresAt) {
                    const timeLeft = expiresAt - now;
                    daysForInput = Math.ceil(timeLeft / (1000 * 60 * 60 * 24));
                    if (daysForInput < 0) daysForInput = 0;
                }

                const adminTools = currentUser.isAdmin ? `
                    <div style="margin-top:10px; padding-top:10px; border-top:1px dashed #444; display:flex; justify-content:space-between; align-items:center;">
                        <span style="font-size:0.7rem; font-weight:bold; color:#666;">DEFINIR DIAS:</span>
                        <div style="display:flex; gap:5px; align-items:center;">
                            <div class="counter-wrapper">
                                <button class="counter-btn" onclick="modGroupDays('${group.groupId}', -1)"><i class="fas fa-minus"></i></button>
                                <input type="number" id="gd-${group.groupId}" class="days-input" value="${daysForInput}">
                                <button class="counter-btn" onclick="modGroupDays('${group.groupId}', 1)"><i class="fas fa-plus"></i></button>
                            </div>
                            <button class="btn-save-days" onclick="admSaveGroupDays('${group.groupId}')" title="Salvar"><i class="fas fa-save"></i></button>
                        </div>
                    </div>
                ` : '';

                const html = `
                    <div class="nested-group-card" id="group-${group.groupId}">
                        <div class="nested-group-header">
                            <div class="nested-group-title text-truncate" title="${group.groupName}">
                                <i class="fas fa-users"></i> ${group.groupName}
                            </div>
                            <span style="font-size:0.75rem; color:${statusColor}; border:1px solid ${statusColor}; padding:4px 8px; border-radius:4px; font-weight:bold;">${statusText}</span>
                        </div>
                        <div style="font-size:0.8rem; color:#888; margin-bottom:10px;">Vence em: <span style="color:#fff; font-weight:600;">${formatDate(group.expiresAt)}</span></div>
                        <div class="nested-group-actions">
                            ${toggleButton}
                            ${editButton}
                            ${actionButton}
                            <button class="btn-nested-action" style="background:rgba(247, 90, 104, 0.2); color:var(--red);" onclick="deleteGroup('${group.groupId}', '${group.groupName}')"><i class="fas fa-trash"></i> Remover</button>
                        </div>
                        ${adminTools}
                    </div>
                `;
                container.innerHTML += html;
            });
        }

        function openGroupEdit(groupId) {
            let group = null;
            Object.values(groupsData).forEach(list => {
                const found = list.find(g => g.groupId === groupId);
                if (found) group = found;
            });

            if (!group) return;

            document.getElementById('edit-group-id-hidden').value = groupId;
            document.getElementById('edit-group-name-display').innerText = group.groupName;
            document.getElementById('edit-group-prompt').value = group.prompt || '';
            document.getElementById('edit-group-silence').value = group.silenceTime || 0;
            document.getElementById('edit-group-botname').value = group.botName || '';
            
            document.getElementById('group-edit-modal').style.display = 'flex';
        }

        document.getElementById('edit-group-form').onsubmit = (e) => {
            e.preventDefault();
            const groupId = document.getElementById('edit-group-id-hidden').value;
            const prompt = document.getElementById('edit-group-prompt').value;
            const silenceTime = document.getElementById('edit-group-silence').value;
            const botName = document.getElementById('edit-group-botname').value;

            socket.emit('update-group-settings', {
                groupId: groupId,
                settings: {
                    prompt: prompt,
                    silenceTime: parseInt(silenceTime),
                    botName: botName
                }
            });
            
            document.getElementById('group-edit-modal').style.display = 'none';
            showFeedback(true, 'Configurações do grupo salvas!');
        };

        function toggleGroupStatus(groupId, isPaused) {
            socket.emit('update-group-settings', {
                groupId: groupId,
                settings: { isPaused: isPaused }
            });
            const card = document.getElementById(`group-${groupId}`);
            if (card) card.style.opacity = '0.7';
        }

        function deleteGroup(groupId, groupName) {
            if(confirm(`Tem certeza que deseja remover o grupo "${groupName}"?\n\nO bot deixará de responder neste grupo e as configurações serão perdidas.`)) {
                socket.emit('delete-group', { groupId: groupId });
                const card = document.getElementById(`group-${groupId}`);
                if(card) card.style.opacity = '0.5';
            }
        }

        async function shareQrCode(sessionName) {
            const card = document.getElementById(`bot-${sessionName}`);
            const container = card.querySelector(`#qr-tgt-${sessionName}`);
            
            if (!container) {
                showFeedback(false, 'QR Code não encontrado.');
                return;
            }

            let sourceUrl = '';
            const canvasEl = container.querySelector('canvas');
            const imgEl = container.querySelector('img');

            if (canvasEl) {
                sourceUrl = canvasEl.toDataURL('image/png');
            } else if (imgEl && imgEl.src) {
                sourceUrl = imgEl.src;
            } else {
                showFeedback(false, 'Imagem QR CODE ainda não gerada.');
                return;
            }

            try {
                const tempImg = new Image();
                tempImg.onload = async () => {
                    const size = 300; 
                    const padding = 20; 
                    
                    const cvs = document.createElement('canvas');
                    cvs.width = size;
                    cvs.height = size;
                    const ctx = cvs.getContext('2d');

                    ctx.fillStyle = '#FFFFFF';
                    ctx.fillRect(0, 0, size, size);

                    ctx.drawImage(tempImg, padding, padding, size - (padding * 2), size - (padding * 2));

                    cvs.toBlob(async (blob) => {
                        if (!blob) {
                            showFeedback(false, 'Erro ao gerar arquivo de imagem.');
                            return;
                        }

                        const file = new File([blob], `qrcode_${sessionName}.png`, { type: "image/png" });

                        if (navigator.canShare && navigator.canShare({ files: [file] })) {
                            await navigator.share({
                                title: 'ZappBot QR Code',
                                text: 'Escaneie este QR Code para conectar o bot ' + sessionName,
                                files: [file]
                            });
                        } else {
                            try {
                                const item = new ClipboardItem({ "image/png": blob });
                                await navigator.clipboard.write([item]);
                                showFeedback(true, 'Imagem copiada para a área de transferência!');
                            } catch (err) {
                                showFeedback(false, 'Seu navegador não suporta compartilhamento nativo.');
                            }
                        }
                    }, 'image/png');
                };
                
                tempImg.src = sourceUrl;

            } catch (err) {
                console.error(err);
                showFeedback(false, 'Erro ao compartilhar: ' + err.message);
            }
        }

        async function sharePixPayment(type) {
            const imgId = type === 'resell' ? 'resell-qrcode-display' : 'pix-qrcode-display';
            const textId = type === 'resell' ? 'resell-copy-paste' : 'pix-copy-paste';

            const img = document.getElementById(imgId);
            const textCode = document.getElementById(textId).value;

            if (!img.src || !textCode) {
                showFeedback(false, 'Informações de pagamento não encontradas.');
                return;
            }

            try {
                const blob = await (await fetch(img.src)).blob();
                const file = new File([blob], "pix_pagamento.png", { type: "image/png" });

                if (navigator.canShare && navigator.canShare({ files: [file] })) {
                    await navigator.share({
                        title: 'Pagamento Pix ZappBot',
                        text: 'Aqui está o código Pix Copia e Cola:\n\n' + textCode,
                        files: [file]
                    });
                } else {
                    copyPixCode(textId);
                    alert('Compartilhamento de arquivo não suportado neste navegador. O código Pix foi copiado para sua área de transferência!');
                }
            } catch (err) {
                console.error(err);
                copyPixCode(textId);
                showFeedback(true, 'Código copiado! (Compartilhamento falhou)');
            }
        }

        function openPairingModal(sessionName) {
            document.getElementById('pairing-sessionName-hidden').value = sessionName;
            document.getElementById('pairing-modal').style.display = 'flex';
        }

        document.getElementById('pairing-form').onsubmit = (e) => {
            e.preventDefault();
            const sessionName = document.getElementById('pairing-sessionName-hidden').value;
            let phoneNumber = document.getElementById('pairing-phone-number').value;
            
            phoneNumber = phoneNumber.replace(/\D/g, '');

            if (phoneNumber.length < 10) {
                showFeedback(false, 'Número inválido. Digite com DDD.');
                return;
            }
            
            socket.emit('stop-bot', { sessionName });
            
            setTimeout(() => {
                socket.emit('start-bot', { sessionName, phoneNumber });
                document.getElementById('pairing-modal').style.display = 'none';
                showFeedback(true, 'Solicitando código de pareamento...');
            }, 1000);
        };

        function sock(ev, name) { socket.emit(ev, { sessionName: name }); }
        function delBot(n) { if(confirm('Apagar "'+n+'"?')) sock('delete-bot', n); }
        function modDays(sessionName, delta) { const input = document.getElementById(`d-${sessionName}`); let val = parseInt(input.value)||0; val+=delta; input.value=val; }
        function admSaveDays(sessionName) { socket.emit('admin-set-days', { sessionName: sessionName, days: document.getElementById(`d-${sessionName}`).value }); }
        
        function modGroupDays(groupId, delta) { 
            const input = document.getElementById(`gd-${groupId}`); 
            let val = parseInt(input.value)||0; 
            val+=delta; 
            input.value=val; 
        }
        function admSaveGroupDays(groupId) { 
            socket.emit('admin-set-group-days', { groupId: groupId, days: document.getElementById(`gd-${groupId}`).value }); 
        }

        function delUser(e, u) { e.stopPropagation(); if(confirm('Apagar usuário '+u+'?')) socket.emit('admin-delete-user', {username:u}); }
        function clearLogs(n) { sessionStorage.removeItem(`log-${n}`); document.querySelector(`#bot-${n} .logs-container`).innerHTML='<div style="display:flex; justify-content:space-between; margin-bottom:5px; color:#666;"><span>TERMINAL</span><span onclick="clearLogs(\''+n+'\')" style="cursor:pointer; font-size:0.65rem; text-decoration:underline;">Limpar</span></div>'; }
        
        function openEdit(n) {
            const bot = botsData[n];
            document.getElementById('edit-modal').style.display='flex';
            document.getElementById('edit-sessionName-hidden').value=n;
            document.getElementById('edit-sessionName-display').value=n;
            document.getElementById('edit-prompt').value=bot.prompt;
            document.getElementById('edit-botTypeGroup').checked = bot.botType === 'group';
            
            document.getElementById('edit-botName').value = bot.botName || '';
            document.getElementById('edit-silenceTime').value = bot.silenceTime || 0;

            if (bot.botType === 'group') {
                document.getElementById('edit-global-settings').classList.add('hidden');
                document.getElementById('edit-group-mode-msg').classList.remove('hidden');
            } else {
                document.getElementById('edit-global-settings').classList.remove('hidden');
                document.getElementById('edit-group-mode-msg').classList.add('hidden');
            }
        }
        function closeEditModal() { document.getElementById('edit-modal').style.display='none'; }
        
        document.getElementById('edit-bot-form').onsubmit = (e) => { 
            e.preventDefault(); 
            socket.emit('update-bot', { 
                sessionName: document.getElementById('edit-sessionName-hidden').value, 
                newPrompt: document.getElementById('edit-prompt').value,
                botType: document.getElementById('edit-botTypeGroup').checked ? 'group' : 'individual',
                botName: document.getElementById('edit-botName').value,
                silenceTime: document.getElementById('edit-silenceTime').value
            }); 
            closeEditModal(); 
        };

        function openIgnoreModal(sessionName) {
            const modal = document.getElementById('ignore-modal');
            document.getElementById('ignore-sessionName-hidden').value = sessionName;
            const bot = botsData[sessionName];
            renderIgnoredIdentifiers(bot.ignoredIdentifiers || []);
            document.getElementById('new-identifier-input').value = ''; 
            modal.style.display = 'flex';
        }

        function renderIgnoredIdentifiers(identifiers) {
            const container = document.getElementById('ignored-list-container');
            container.innerHTML = '';
            if (!identifiers || identifiers.length === 0) {
                container.innerHTML = '<p style="text-align:center; color:var(--text-muted); font-size:0.8rem;">Nenhum nome na lista.</p>';
            } else {
                identifiers.forEach((item, index) => {
                    const el = document.createElement('div');
                    el.className = 'ignored-item';
                    el.innerHTML = `<span>${item.value}</span><i class="fas fa-times" onclick="removeIdentifier(${index})"></i>`;
                    container.appendChild(el);
                });
            }
        }
        
        document.getElementById('add-identifier-form').onsubmit = (e) => {
            e.preventDefault();
            const sessionName = document.getElementById('ignore-sessionName-hidden').value;
            const input = document.getElementById('new-identifier-input');
            const value = input.value.trim();
            if (!value) return;
            const currentList = botsData[sessionName].ignoredIdentifiers || [];
            const isDuplicate = currentList.some(item => item.value.toLowerCase() === value.toLowerCase());
            if (isDuplicate) { showFeedback(false, 'Este nome já está na lista.'); return; }
            const newList = [...currentList, { type: 'name', value: value }];
            updateIgnoredListOnServer(sessionName, newList);
            renderIgnoredIdentifiers(newList); 
            input.value = '';
        };

        function removeIdentifier(indexToRemove) {
            const sessionName = document.getElementById('ignore-sessionName-hidden').value;
            const currentList = botsData[sessionName].ignoredIdentifiers || [];
            const newList = currentList.filter((_, index) => index !== indexToRemove);
            updateIgnoredListOnServer(sessionName, newList);
            renderIgnoredIdentifiers(newList); 
        }

        function updateIgnoredListOnServer(sessionName, newList) {
            botsData[sessionName].ignoredIdentifiers = newList; 
            socket.emit('update-ignored-identifiers', { sessionName, ignoredIdentifiers: newList });
        }

        document.getElementById('add-bot-form').onsubmit=(e)=>{
            e.preventDefault(); 
            const nInput = document.getElementById('sessionName');
            const pInput = document.getElementById('prompt');
            const botType = document.getElementById('selectedBotType').value; 
            const platformInput = document.getElementById('botPlatform');
            const tokenInput = document.getElementById('telegramToken');

            let n = nInput.value.trim().replace(/\s+/g,'_');
            if(n.length < 3) { alert('O nome deve ter 3 letras.'); return; }
            
            if (platformInput.value === 'telegram' && !tokenInput.value.trim()) {
                alert('Para Telegram, o Token é obrigatório.');
                return;
            }

            const o = (currentUser.isAdmin && viewedUser) ? viewedUser : currentUser.username;
            const btn = document.getElementById('create-bot-btn');
            btn.disabled = true; btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Criando...';
            
            console.log("Enviando criação de bot:", {
                sessionName: n,
                platform: platformInput.value,
                token: tokenInput.value,
                botType: botType
            });

            socket.emit('create-bot', { 
                sessionName:n, 
                prompt: botType === 'group' ? '' : pInput.value.trim(), 
                owner:o,
                botType: botType,
                botName: '', 
                silenceTime: 0, 
                platform: platformInput.value,
                token: tokenInput.value.trim()
            });
            
            nInput.value=''; pInput.value=''; 
            tokenInput.value = '';
        };
        
        document.getElementById('admin-settings-form').onsubmit=(e)=>{ 
            e.preventDefault(); 
            socket.emit('save-settings', { 
                mpAccessToken: document.getElementById('mp-access-token').value, 
                priceMonthly: document.getElementById('price-monthly').value,
                priceQuarterly: document.getElementById('price-quarterly').value,
                priceSemiannual: document.getElementById('price-semiannual').value,
                priceYearly: document.getElementById('price-yearly').value,
                priceResell5: document.getElementById('price-resell-5').value,
                priceResell10: document.getElementById('price-resell-10').value,
                priceResell20: document.getElementById('price-resell-20').value,
                priceResell30: document.getElementById('price-resell-30').value,
            }); 
            showFeedback(true, 'Configurações salvas!');
        };

        let currentPaySession = '';
        let currentPayGroup = '';
        function openPay(sessionName = null, groupId = null, groupName = null) {
            currentPaySession = sessionName;
            currentPayGroup = groupId;

            const m = document.getElementById('payment-modal'); 
            m.style.display='flex';
            
            if (groupId) {
                document.getElementById('payment-target-label').innerText = 'Grupo';
                document.getElementById('pay-session-name').innerText = groupName;
            } else {
                document.getElementById('payment-target-label').innerText = 'Robô';
                document.getElementById('pay-session-name').innerText = sessionName;
            }

            const container = document.getElementById('plans-container');
            container.innerHTML = '';
            const plans = [
                { id: 'monthly', title: 'Mensal', price: publicPrices.monthly, desc: '30 dias' },
                { id: 'quarterly', title: 'Trimestral', price: publicPrices.quarterly, desc: '90 dias' },
                { id: 'semiannual', title: 'Semestral', price: publicPrices.semiannual, desc: '180 dias' },
                { id: 'yearly', title: 'Anual', price: publicPrices.yearly, desc: '365 dias' }
            ];
            plans.forEach(p => {
                const el = document.createElement('div'); el.className = 'plan-option';
                el.innerHTML = `<div><div class="plan-title">${p.title}</div><div class="plan-desc">${p.desc}</div></div><div class="plan-price">R$ ${p.price}</div>`;
                el.onclick = () => selectPlan(p.id);
                container.appendChild(el);
            });
            document.getElementById('pay-step-select').classList.remove('hidden');
            document.getElementById('pix-loading').classList.add('hidden');
            document.getElementById('pix-content').classList.add('hidden');
        }

        async function selectPlan(planType) {
            document.getElementById('pay-step-select').classList.add('hidden');
            document.getElementById('pix-loading').classList.remove('hidden');
            
            const payload = { planType: planType };
            if (currentPayGroup) {
                payload.groupId = currentPayGroup;
            } else {
                payload.sessionName = currentPaySession;
            }

            try {
                const res = await fetch('/api/create-payment', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(payload) });
                const d = await res.json();
                if(res.ok) {
                    document.getElementById('pix-loading').classList.add('hidden');
                    document.getElementById('pix-content').classList.remove('hidden');
                    document.getElementById('pay-amount').innerText = `R$ ${d.amount}`;
                    document.getElementById('pix-qrcode-display').src = `data:image/png;base64,${d.qr_code_base64}`;
                    document.getElementById('pix-copy-paste').value = d.qr_code;
                } else { 
                    alert(d.error || 'Erro ao gerar Pix'); 
                    closePaymentModal(); 
                }
            } catch { alert('Erro conexão'); closePaymentModal(); }
        }

        function openResellModal() {
            const m = document.getElementById('resell-modal');
            m.style.display = 'flex';
            const container = document.getElementById('resell-plans-container');
            container.innerHTML = '';
            const resellPlans = [
                { id: 'resell_5', title: 'Pacote 5 Robôs', price: publicPrices.resell5, limit: 5 },
                { id: 'resell_10', title: 'Pacote 10 Robôs', price: publicPrices.resell10, limit: 10 },
                { id: 'resell_20', title: 'Pacote 20 Robôs', price: publicPrices.resell20, limit: 20 },
                { id: 'resell_30', title: 'Pacote 30 Robôs', price: publicPrices.resell30, limit: 30 },
            ];
            resellPlans.forEach(p => {
                const el = document.createElement('div'); el.className = 'plan-option';
                el.innerHTML = `<div><div class="plan-title">${p.title} <span class="plan-badge-resell">Revenda</span></div><div class="plan-desc">Limite de ${p.limit} bots.</div></div><div class="plan-price">R$ ${p.price}</div>`;
                el.onclick = () => selectResellPlan(p.id);
                container.appendChild(el);
            });
            document.getElementById('resell-step-select').classList.remove('hidden');
            document.getElementById('resell-pix-loading').classList.add('hidden');
            document.getElementById('resell-pix-content').classList.add('hidden');
        }

        async function selectResellPlan(planId) {
            document.getElementById('resell-step-select').classList.add('hidden');
            document.getElementById('resell-pix-loading').classList.remove('hidden');
            try {
                const res = await fetch('/api/create-payment', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({ planType: planId }) });
                const d = await res.json();
                if(res.ok) {
                    document.getElementById('resell-pix-loading').classList.add('hidden');
                    document.getElementById('resell-pix-content').classList.remove('hidden');
                    document.getElementById('resell-pay-amount').innerText = `R$ ${d.amount}`;
                    document.getElementById('resell-qrcode-display').src = `data:image/png;base64,${d.qr_code_base64}`;
                    document.getElementById('resell-copy-paste').value = d.qr_code;
                } else { alert(d.error || 'Erro ao gerar Pix'); document.getElementById('resell-modal').style.display='none'; }
            } catch { alert('Erro conexão'); document.getElementById('resell-modal').style.display='none'; }
        }

        function resetPaymentModal() { 
            if (currentPayGroup) {
                const groupName = document.getElementById('pay-session-name').innerText;
                openPay(null, currentPayGroup, groupName);
            } else {
                openPay(currentPaySession);
            }
        }
        function copyPixCode(id) { const el=document.getElementById(id); el.select(); navigator.clipboard.writeText(el.value); showFeedback(true, 'Código Pix Copiado!'); }
        function closePaymentModal() { document.getElementById('payment-modal').style.display='none'; }
        window.onclick = (e) => { if(e.target.className === 'modal-overlay') e.target.style.display='none'; };

        async function openGroupActivationModal(sessionName) {
            const btn = document.querySelector(`#bot-${sessionName} .btn-primary`);
            const originalHtml = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';

            try {
                const response = await fetch('/api/generate-activation-link', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ botSessionName: sessionName })
                });
                const data = await response.json();

                if (response.ok) {
                    document.getElementById('modal-bot-name').textContent = sessionName;
                    document.getElementById('activation-link-input').value = data.activationLink;
                    document.getElementById('activation-link-modal').style.display = 'flex';
                } else {
                    showFeedback(false, data.error || 'Não foi possível gerar o link.');
                }
            } catch (error) {
                showFeedback(false, 'Erro de conexão ao gerar o link.');
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalHtml;
            }
        }

        document.getElementById('copy-activation-link-btn').addEventListener('click', () => {
            const input = document.getElementById('activation-link-input');
            input.select();
            navigator.clipboard.writeText(input.value);
            showFeedback(true, 'Link Copiado!');
        });

        function downloadBackup() {
            window.location.href = '/api/admin/backup';
        }

        async function handleRestoreFile() {
            const input = document.getElementById('restore-file-input');
            if (input.files.length === 0) return;

            const file = input.files[0];
            const formData = new FormData();
            formData.append('backupFile', file);

            if (!confirm('ATENÇÃO: Restaurar um backup irá sobrescrever todos os usuários, bots e configurações atuais. Os bots serão reiniciados. Deseja continuar?')) {
                input.value = '';
                return;
            }

            try {
                showFeedback(true, 'Enviando backup e restaurando...');
                const response = await fetch('/api/admin/restore', {
                    method: 'POST',
                    body: formData
                });
                const data = await response.json();

                if (response.ok) {
                    showFeedback(true, data.message);
                    setTimeout(() => window.location.reload(), 3000);
                } else {
                    showFeedback(false, data.error || 'Erro ao restaurar backup.');
                }
            } catch (error) {
                showFeedback(false, 'Erro de conexão ao restaurar.');
            }
            input.value = '';
        }
    </script>
</body>
</html>

